<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥‡é–€éç”² - æ™‚ç©ºç¾…ç›¤</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-gold: #d4af37;
            --accent-red: #c0392b;
            --accent-green: #27ae60;
            --accent-blue: #2980b9;
            --border-color: #333;
            --grid-line: #444;
        }

        body {
            font-family: '-apple-system', 'BlinkMacSystemFont', 'SF Pro', 'SF Pro Display', 'PingFang TC', 'Inter', 'Roboto', 'AppleGothic', 'Microsoft JhengHei UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        header {
            width: 100%;
            padding: 15px 0;
            text-align: center;
            background: rgba(18, 18, 18, 0.95);
            border-bottom: 1px solid var(--accent-gold);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent-gold);
            letter-spacing: 2px;
            font-weight: 400;
        }

        .container {
            width: 95%;
            max-width: 600px;
            padding: 10px 0 40px 0;
            /* Increased bottom padding */
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center cards */
            gap: 15px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            width: 375px;
            box-sizing: border-box;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .card-title {
            font-size: 1rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="datetime-local"] {
            font-family: '-apple-system', 'BlinkMacSystemFont', 'SF Pro', 'SF Pro Display', 'PingFang TC', 'Inter', 'Roboto', 'AppleGothic', 'Microsoft JhengHei UI', sans-serif;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 6px;
            font-size: 1rem;
            flex: 1;
        }

        .btn {
            background-color: var(--accent-gold);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn:active {
            transform: scale(0.96);
        }

        /* Info Grid */
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .highlight {
            color: var(--accent-gold);
            font-weight: bold;
        }

        .auspicious {
            color: var(--accent-green);
        }

        .inauspicious {
            color: var(--accent-red);
        }

        /* Nine Palace Grid (Jiu Gong) */
        .qimen-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            background-color: var(--grid-line);
            border: 2px solid var(--accent-gold);
            aspect-ratio: 1;
            margin-top: 10px;
            border-radius: 4px;
            overflow: hidden;
        }

        .palace {
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: rgba(20, 20, 20, 0.8);
            transition: box-shadow 0.3s ease;
        }

        /* Zhi Fu Highlight */
        .palace.highlight-zhifu {
            box-shadow: inset 0 0 15px rgba(241, 196, 15, 0.3);
            border-color: rgba(241, 196, 15, 0.6);
        }

        /* Compass Mode Styles - Reverted to Square */
        .qimen-grid.compass-active {
            gap: 0;
        }

        .qimen-grid.compass-active .palace {
            border-radius: 0;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #444;
            box-shadow: none;
        }

        /* Ensure Zhi Fu highlight persists in compass mode */
        .qimen-grid.compass-active .palace.highlight-zhifu {
            box-shadow: inset 0 0 15px rgba(241, 196, 15, 0.3);
            border-color: rgba(241, 196, 15, 0.6);
        }

        /* Palace Content Layout */
        .p-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .p-body {
            display: flex;
            gap: 5px;
            font-weight: bold;
            font-size: 1.1rem;
            margin: 2px 0;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            flex: 1;
        }

        .star {
            color: #e74c3c;
        }

        /* Heaven Star */
        .door {
            color: #f1c40f;
        }

        /* Man Door */
        .door.auspicious {
            color: #f1c40f;
            text-shadow: 0 0 5px rgba(241, 196, 15, 0.5);
        }

        .god {
            color: #3498db;
            font-size: 0.8rem;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        /* Deity */
        .stems {
            font-size: 0.9rem;
            color: #ccc;
            display: flex;
            gap: 3px;
            flex-direction: column;
            position: absolute;
            bottom: 2px;
            left: 4px;
            /* Moved to left */
            line-height: 1.1;
            text-align: left;
            /* Align left */
        }

        .heaven-stem {
            color: #e74c3c;
            /* Guest */
        }

        .earth-stem {
            color: #95a5a6;
            /* Host */
        }

        .gong-element {
            position: absolute;
            top: 2px;
            right: 4px;
            /* Moved to right */
            font-size: 0.7rem;
            color: #afafaf;
            font-weight: bold;
        }

        .gong-name {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.7rem;
            color: #afafaf;
        }

        /* Compass Overlay Mode */
        .compass-container {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .compass-ring {
            width: 90%;
            height: 90%;
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s ease-out;
        }

        .compass-mark {
            position: absolute;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Guide Section */
        .guide-box {
            background: rgba(212, 175, 55, 0.1);
            border-left: 3px solid var(--accent-gold);
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Markers */
        .marker {
            position: absolute;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-muted);
            pointer-events: none;
            z-index: 20;
            /* Above grid */
            text-shadow: 0 0 3px #000;
        }

        /* Adjust marker positions to be outside the rotating area */
        .marker.top {
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--accent-red);
        }

        .marker.bottom {
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
        }

        .marker.left {
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .marker.right {
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Sections */
        .section-title {
            font-size: 1.1rem;
            color: var(--accent-gold);
            margin: 20px 0 10px 0;
            border-left: 3px solid var(--accent-gold);
            padding-left: 10px;
        }

        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            color: #555;
            font-size: 0.8rem;
        }

        /* Markers for Xing, Mu, Po */
        .marker-badge {
            font-size: 0.6rem;
            padding: 1px 3px;
            border-radius: 3px;
            color: #fff;
            display: inline-block;
            line-height: 1;
        }

        .marker-xing {
            background-color: #c0392b;
        }

        /* Red */
        .marker-mu {
            background-color: #7f8c8d;
        }

        /* Orange */
        .marker-po {
            background-color: #d35400;
        }

        /* Interaction Badge */
        .interaction-badge {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            color: #fff;
            white-space: nowrap;
            z-index: 5;
        }

        .interaction-good {
            background-color: rgba(39, 174, 96, 0.8);
        }

        /* Green */
        .interaction-bad {
            background-color: rgba(192, 57, 43, 0.8);
        }

        /* Red */
        .interaction-neutral {
            background-color: rgba(127, 140, 141, 0.8);
        }

        /* Grey */
        .interaction-warn {
            background-color: rgba(243, 156, 18, 0.8);
        }

        /* Orange */
        .interaction-control {
            background-color: rgba(41, 128, 185, 0.8);
        }

        /* Blue */
        /* Welcome Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-title {
            color: var(--accent-gold);
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .disclaimer-list {
            text-align: left;
            color: var(--text-main);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 30px;
            padding-left: 20px;
        }

        .disclaimer-list li {
            margin-bottom: 10px;
        }

        .modal-btn {
            background: var(--accent-gold);
            color: #000;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .modal-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }
    </style>
    <script>
        //ç¦æ­¢æ‹–å‹•
        document.addEventListener("dragstart", function (e) {
            e.preventDefault();
        });

        //ç¦ç”¨éƒ¨åˆ†çµ„åˆ
        document.addEventListener("keydown", function (e) {
            // F12
            if (e.keyCode == 123) {
                e.preventDefault();
                // Ctrl+Shift+I
            } else if (e.ctrlKey && e.shiftKey && e.keyCode == 73) {
                // e.preventDefault();
                // Shift+F10
            } else if (e.shiftKey && e.keyCode == 121) {
                e.preventDefault();
                // Ctrl+U
            } else if (e.ctrlKey && e.keyCode == 85) {
                e.preventDefault();
                // Command+Option+I
            } else if (e.metaKey && e.altKey && e.keyCode == 73) {
                e.preventDefault();
            }
        });

        //å‹•æ…‹é é¢æ¨™é¡Œ
        const OriginTitle = document.title;
        let titleTime;
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                document.title = 'O_O é é¢å·²éš±è— - ' + OriginTitle;
                titleTime = setTimeout(function () {
                    document.title = OriginTitle;
                }, 1500);
                //  clearTimeout(titleTime);
            } else {
                document.title = 'ãƒ¾(Åâˆ€Å3)ãƒæ­¡è¿å›ä¾†ï¼ - ' + OriginTitle;
                titleTime = setTimeout(function () {
                    document.title = OriginTitle;
                }, 1500);
            }
        });


        //ç¦æ­¢é›™æ“Šç¸®æ”¾
        let lastTouchEndTime = 0;
        document.addEventListener('touchend', (event) => {
            const now = new Date().getTime();
            if ((now - lastTouchEndTime) <= 300) {      // åµæ¸¬æ™‚é–“å·®æ˜¯å¦å°æ–¼ 300ms
                event.preventDefault();
            }
            lastTouchEndTime = now;
        }, false);

        // [Safari only] gesturestart event: multi finger gestures touching
        document.addEventListener('gesturestart', function (event) {
            // é˜»æ­¢å…©æŒ‡ç¸®æ”¾ç•«é¢
            event.preventDefault();
        });

        //åˆ—å°
        window.onbeforeprint = function () {
            location.reload()
        }

    </script>
</head>

<body>

    <header>
        <h1 style="font-weight: bold;">å¥‡é–€éç”² Â· æ™‚ç©ºç¾…ç›¤</h1>
    </header>

    <div class="container">

        <!-- Control Card -->
        <div class="card">
            <div class="controls">
                <input type="datetime-local" id="datetime-picker">
                <button class="btn" onclick="resetToNow()">ç¾åœ¨</button>
            </div>
            <div class="info-row">
                <span>çœŸå¤ªé™½æ™‚:</span>
                <span id="solar-time-display" class="highlight">--:--</span>
            </div>
            <div class="info-row">
                <span>å››æŸ±:</span>
                <span id="bazi-display">--</span>
            </div>
            <div class="info-row">
                <span>å±€æ•¸:</span>
                <span id="ju-shu-display" class="highlight">è¨ˆç®—ä¸­...</span>
            </div>
            <div class="info-row">
                <span>æ—¬é¦–:</span>
                <span id="xun-shou-display">--</span>
            </div>
            <div class="info-row" style="margin-top: 8px; border-top: 1px solid #333; padding-top: 5px;">
                <span>ç¯€æ°£:</span>
                <span id="solar-term-display" style="color: var(--text-muted);">--</span>
            </div>
            <div class="info-row">
                <span>ä»Šæ—¥ç”²æ™‚:</span>
                <span id="jia-hours-display" style="color: var(--accent-gold); font-size: 0.9rem;">è¨ˆç®—ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- Main Chart Area -->
    <div class="card" style="position: relative; overflow: visible; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span class="card-title">å¥‡é–€ç›¤ (æ™‚ç›¤)</span>
            <button class="btn btn-outline" id="compass-toggle" onclick="toggleCompass()"
                style="font-size: 0.8rem; padding: 4px 12px;">å•Ÿç”¨ç¾…ç›¤</button>
        </div>

        <div id="chart-container"
            style="position: relative; width: 85%; max-width: 350px; margin: 30px auto; aspect-ratio: 1;">
            <!-- Rotating Wrapper -->
            <div id="rotating-ring"
                style="width: 100%; height: 100%; position: relative; transition: transform 0.1s ease-out;">
                <!-- Markers (Inside to rotate) -->
                <div class="marker top">å—</div>
                <div class="marker bottom">åŒ—</div>
                <div class="marker left">æ±</div>
                <div class="marker right">è¥¿</div>

                <!-- The Grid -->
                <div class="qimen-grid" id="qimen-grid" style="width: 100%; height: 100%; margin: 0;">
                    <!-- Palaces will be generated by JS -->
                </div>
            </div>

            <!-- Indicator (Fixed on screen, visible only in compass mode) -->
            <div id="compass-indicator"
                style="position: absolute; width: 4px; height: 20px; background: red; top: -30px; left: 50%; transform: translateX(-50%); z-index: 10; display: none; border-radius: 2px;">
            </div>
        </div>

        <div class="guide-box" style="margin-top: 30px;">
            <strong>æ–°æ‰‹å¼•å°ï¼š</strong><br>
            <span style="color:#e74c3c">ç´…å­—</span>ä¹æ˜Ÿ (å¤©)ï¼Œ<span style="color:#f1c40f">é»ƒå­—</span>å…«é–€ (äºº)ï¼Œ<span
                style="color:#3498db">è—å­—</span>å…«ç¥ (ç¥)ã€‚<br>
            å‰æ–¹ï¼šç”Ÿã€é–‹ã€ä¼‘ã€‚å¤©ç›¤å¹²ç‚ºç´…è‰²ï¼Œåœ°ç›¤å¹²ç‚ºç°è‰²ã€‚
        </div>
    </div>

    <!-- Analysis Section -->
    <div class="section-title">å‰å‡¶æŒ‡å—</div>
    <div class="card">
        <div class="card-header">
            <span class="card-title">ç¸½çµ</span>
        </div>
        <div id="chart-summary" style="font-size: 0.9rem; line-height: 1.6;">
            <!-- Summary content -->
        </div>
    </div>
    <div class="card" style="margin-top: 15px;">
        <div class="card-header">
            <span class="card-title">é¢¨éšªè©•ä¼°</span>
        </div>
        <div id="risk-assessment" style="font-size: 0.9rem;"></div>
    </div>
    <div class="card" style="margin-top: 15px;">
        <div class="card-header">
            <span class="card-title">å‰æ–¹é€ŸæŸ¥</span>
        </div>
        <div id="lucky-directions"></div>
    </div>
    <div class="card" style="margin-top: 15px;">
        <div class="card-header">
            <span class="card-title">æ ¼å±€åˆ†æ</span>
        </div>
        <div id="pattern-analysis"></div>
    </div>

    <!-- Beginner Guide Section -->
    <div class="section-title">æ–°æ‰‹ä½¿ç”¨æ•™å­¸</div>
    <div class="card">
        <!-- Tabs Header -->
        <div style="display: flex; border-bottom: 1px solid #444; margin-bottom: 15px;">
            <div class="tab-btn active" onclick="switchGuideTab('decision')" id="tab-btn-decision"
                style="padding: 8px 15px; cursor: pointer; border-bottom: 2px solid var(--accent-gold); color: var(--accent-gold); font-weight: bold;">
                é¸æ“‡å›°é›£
            </div>
            <div class="tab-btn" onclick="switchGuideTab('travel')" id="tab-btn-travel"
                style="padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-muted);">
                å‡ºéŠå‰å‡¶
            </div>
        </div>

        <!-- Tab Content: Decision -->
        <div id="guide-decision" class="guide-content" style="font-size: 0.9rem; line-height: 1.8; color: #ddd;">
            <h3 style="color:var(--accent-gold); margin-top:0;">ğŸ“˜ã€Šå¥‡é–€éç”² Â· é¸æ“‡å›°é›£æ¨¡å¼ã€‹</h3>
            <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:15px;">
                ç°¡å–®äº”æ­¥é©Ÿåˆ¤æ–· A/B å…©å€‹é¸é …å­°å„ª<br>
                é©ç”¨ï¼šè²·è»Šã€é¸å…¬å¸ã€é¸æˆ¿é–“ã€é¸ç§‘ç³»ã€é¸å…©é–“åº—... åªè¦æ˜¯ 2 é¸ 1 éƒ½èƒ½ç”¨ã€‚
            </p>

            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:15px;">
                <strong>â­ ç¬¬ 0 æ­¥ï¼š</strong> æ±ºå®šå¥½ã€Œå…©å€‹é¸é …ã€åœ¨å¿ƒè£¡ï¼Œåœ¨ç›¤ä¸Šé¸æ“‡ã€Œä½ å•å•é¡Œçš„æ™‚é–“ã€(æˆ–æœ€æ—©é–‹å§‹çŒ¶è±«çš„æ™‚é–“)
            </div>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">â‘  æ‰¾åˆ°å®®ä½ (æœ€é‡è¦)</h4>
            <p>
                â— <strong style="color:#f1c40f">ç”Ÿé–€</strong> æ‰€åœ¨çš„å®® â†’ ä»£è¡¨ <strong>é¸é … A</strong><br>
                â— <strong style="color:#f1c40f">é–‹é–€</strong> æ‰€åœ¨çš„å®® â†’ ä»£è¡¨ <strong>é¸é … B</strong><br>
                <span style="font-size:0.8rem; color:#aaa;">(ç”Ÿé–€=æˆé•·/è²¡/ç™¼å±•ï¼Œé–‹é–€=é–‹å§‹/è¡Œå‹•/é€²å…¥)</span>
            </p>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">â‘¡ æ¯”é–€ (æ ¸å¿ƒæŒ‡æ¨™)</h4>
            <p>
                <strong>å‰ï¼š</strong> ç”Ÿ ï¼ é–‹ ï¼ ä¼‘<br>
                <strong>å¹³ï¼š</strong> æ™¯ ï¼ æœ<br>
                <strong>å‡¶ï¼š</strong> å‚· ï¼ é©š ï¼ æ­»<br>
                ğŸ“Œ æ¯”è¼ƒï¼šèª°çš„é–€æ¯”è¼ƒå‰ â†’ å„ªå…ˆé¸é‚£é‚Š
            </p>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">â‘¢ æ¯”æ˜Ÿ (ç¬¬äºŒé‡è¦)</h4>
            <p>
                <strong>å‰ï¼š</strong> å¤©è¼”(æœ€ä½³) ï¼ å¤©å¿ƒ ï¼ å¤©ä»»<br>
                <strong>å¹³ï¼š</strong> å¤©è‹± ï¼ å¤©æŸ±<br>
                <strong>å‡¶ï¼š</strong> å¤©èŠ®(ç‘•ç–µ) ï¼ å¤©è“¬(å·®) ï¼ å¤©æ²–(äº‚)<br>
                ğŸ“Œ æ¯”è¼ƒï¼šèª°æ¯”è¼ƒå‰ â†’ åŠ  1 åˆ†
            </p>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">â‘£ æ¯”ç¥ (å‰¯ä½œç”¨)</h4>
            <p>
                <strong>å‰ï¼š</strong> å¤ªé™°ã€å…­åˆã€ä¹å¤© (ä½³)<br>
                <strong>å‡¶ï¼š</strong> ç™½è™(çˆ­åµ)ã€ç„æ­¦(è¢«é¨™)<br>
                ğŸ“Œ æ¯”è¼ƒï¼šèª°æ¯”è¼ƒä¹¾æ·¨ â†’ åŠ åˆ†
            </p>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">â‘¤ ç¸½çµ</h4>
            <p>
                åŠ ç¸½ A èˆ‡ B çš„å„ªåŠ£ï¼Œåˆ†æ•¸é«˜è€…ç‚ºä½³ã€‚<br>
                <span style="color:#e74c3c; font-size:0.85rem;">â€» è‹¥å€¼ç¬¦è½æ­»é–€æˆ–ç›¤å‹¢æ··äº‚ â†’ æ­¤æ™‚è¾°ä¸é©åˆå•ï¼Œè«‹æ›ä¸‹ä¸€æ™‚è¾°é‡æ’ã€‚</span>
            </p>
        </div>

        <!-- Tab Content: Travel -->
        <div id="guide-travel" class="guide-content"
            style="display: none; font-size: 0.9rem; line-height: 1.8; color: #ddd;">
            <h3 style="color:var(--accent-gold); margin-top:0;">ğŸ“˜ã€Šå¥‡é–€éç”²ï¼šä»Šå¤©é©ä¸é©åˆå‡ºå»ç©ï¼Ÿã€‹</h3>
            <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:15px;">
                å¦‚ä½•ä½¿ç”¨æ™‚ç›¤çœ‹æ—…éŠæ–¹å‘å‰å‡¶
            </p>

            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:15px;">
                <strong>1ï¸âƒ£ ç¢ºèªæ–¹ä½ï¼š</strong> æ—…éŠåœ°ç›¸å°ä½ å®¶çš„æ–¹ä½ (åŒ—ã€å—ã€æ±ã€è¥¿...)<br>
                <strong>2ï¸âƒ£ é–‹ç›¤æ™‚é–“ï¼š</strong> ä»¥ã€Œå‡ºé–€çš„é‚£ä¸€åˆ»ã€ç‚ºæº–
            </div>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">3ï¸âƒ£ æ‰¾åˆ°å°æ‡‰å®®ä½</h4>
            <p>
                åŒ—æ–¹(åä¸€)ã€è¥¿å—(å¤äºŒ)ã€æ±æ–¹(éœ‡ä¸‰)ã€æ±å—(å·½å››)<br>
                ä¸­å¤®(ä¸­äº”)ã€è¥¿åŒ—(ä¹¾å…­)ã€è¥¿æ–¹(å…Œä¸ƒ)ã€æ±åŒ—(è‰®å…«)ã€å—æ–¹(é›¢ä¹)
            </p>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">4ï¸âƒ£ æŸ¥çœ‹è©²å®®å…«é–€ (å‰å‡¶é—œéµ)</h4>
            <ul style="margin: 5px 0 10px 20px; padding: 0;">
                <li><strong style="color:#f1c40f"> å‰é–€ (é©åˆå‡ºå»ç©)ï¼š</strong><br>
                    <strong>ç”Ÿé–€ (æœ€å¥½)ï¼š</strong> ç©å¾—é †ã€å¤©æ°£ä½³ã€è²·åˆ°æƒ³è²·çš„<br>
                    <strong>é–‹é–€ï¼š</strong> æ´»å‹•é †åˆ©ã€äº¤é€šé †<br>
                    <strong>ä¼‘é–€ï¼š</strong> æ¬£è³å‹æ—…éŠã€è‡ªç„¶ã€æ•£å¿ƒè¶…å¥½
                </li>
                <li><strong style="color:var(--accent-blue);margin-top:5px;">â– å¹³é–€ (æ™®é€š)ï¼š</strong><br>
                    <strong>æ™¯é–€ï¼š</strong> æ‹ç…§å¾ˆå¥½çœ‹ï¼Œä½†èµ°èµ·ä¾†æ¯”è¼ƒç´¯<br>
                    <strong>æœé–€ï¼š</strong> æ…¢ã€å¡è»Šã€æ™¯é»é—œé–‰ã€æ’éšŠ
                </li>
                <li style="margin-top:5px;"><strong style="color:#e74c3c">âŒ å‡¶é–€ (ä¸é©åˆå»ç©)ï¼š</strong><br>
                    <strong>é©šé–€ï¼š</strong> çªç™¼ç‹€æ³ã€è¿·è·¯ã€è³‡è¨Šæ··äº‚<br>
                    <strong>å‚·é–€ï¼š</strong> æœƒç´¯ã€æœƒå—å‚·ã€è·Œå€’ã€èº«é«”ä¸èˆ’æœ<br>
                    <strong>æ­»é–€ï¼š</strong> å¤©æ°£å·®ã€ç©ä¸é–‹å¿ƒã€ç™½è·‘ä¸€è¶Ÿ
                </li>
            </ul>

            <h4 style="color:var(--accent-gold); margin:10px 0 5px 0;">5ï¸âƒ£ åŠ åˆ†åƒè€ƒ</h4>
            <p>
                <strong>âœ” 1. ä¹æ˜Ÿ (åŠ æ¸›åˆ†)</strong><br>
                å¤©è¼”/å¤©å¿ƒ/å¤©ä»» â†’ å‡ºéŠè®š<br>
                å¤©è‹± â†’ æ™¯è‰²æ¼‚äº®<br>
                å¤©èŠ® â†’ å®¹æ˜“ç”Ÿç—…æˆ–è·¯ç·šä¸èˆ’æœ<br>
                å¤©æ²–/å¤©è“¬ â†’ æ··äº‚ã€åµã€ç´¯ã€äº‹æ•…
            </p>
            <p>
                <strong>âœ” 2. å…«ç¥ (å‰¯ä½œç”¨)</strong><br>
                å¤ªé™°ã€å…­åˆ â†’ é©åˆæ–‡é’è¡Œç¨‹<br>
                ä¹å¤© â†’ é©åˆç™»å±±ã€é«”èƒ½<br>
                ç™½è™ã€ç„æ­¦ â†’ ä»Šå¤©çœŸçš„ä¸è¦äº‚è·‘
            </p>
            <p>
                <strong>âœ” 3. å®®ä½äº”è¡Œ</strong><br>
                ç«ä½ (é›¢ä¹) â†’ éŠç©æœ€å—¨<br>
                æœ¨ä½ (éœ‡ä¸‰/å·½å››) â†’ è¸©é»æ‹ç…§ä½³<br>
                æ°´ä½ (åä¸€) â†’ é©åˆä¼‘æ¯<br>
                åœŸä½ (å¤äºŒ/è‰®å…«) â†’ é©åˆè¼•é¬†è¡Œç¨‹
            </p>

            <div
                style="margin-top:15px; padding:10px; border-left:3px solid var(--accent-gold); background:rgba(212, 175, 55, 0.1);">
                <strong>ğŸ‘‰ çµè«–ï¼š</strong><br>
                è‹¥è©²æ–¹ä½è½ <strong>å‰é–€</strong> â†’ ä»Šå¤©é©åˆå¾€é‚£è£¡ç©ï¼
            </div>
        </div>

        <script>
            function switchGuideTab(tab) {
                // Hide all content
                document.querySelectorAll('.guide-content').forEach(el => el.style.display = 'none');
                // Show selected content
                document.getElementById('guide-' + tab).style.display = 'block';

                // Reset tabs
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.style.borderBottom = '2px solid transparent';
                    el.style.color = 'var(--text-muted)';
                    el.style.fontWeight = 'normal';
                });
                // Activate selected tab
                const activeBtn = document.getElementById('tab-btn-' + tab);
                activeBtn.style.borderBottom = '2px solid var(--accent-gold)';
                activeBtn.style.color = 'var(--accent-gold)';
                activeBtn.style.fontWeight = 'bold';
            }
        </script>
    </div>

    <!-- Guide Section -->
    <div class="section-title">èªªæ˜æ›¸</div>
    <div class="card">
        <div style="font-size: 0.9rem; line-height: 1.8; color: #ddd;">

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px; margin-top:0;">0.
                åˆ¤æ–·å„ªå…ˆé †åº</h3>
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:5px; margin-bottom:15px;">
                <div>1ï¸âƒ£ <strong>å¤©å¹²</strong> (ä½”å‰å‡¶ 70%) <span style="color:#aaa; font-size:0.85rem;">å¤©ç›¤è¡¨å¤–åŠ›ã€åœ°ç›¤è¡¨æœ¬è³ª</span>
                </div>
                <div style="margin-top:5px;">2ï¸âƒ£ <strong>å…«é–€</strong> (è¡Œç‚ºç›®çš„)</div>
                <div style="margin-top:5px;">3ï¸âƒ£ <strong>ä¹æ˜Ÿ</strong> (è¶¨å‹¢)</div>
                <div style="margin-top:5px;">4ï¸âƒ£ <strong>å…«ç¥</strong> (æ°£æ°›)</div>
                <div style="margin-top:5px;">5ï¸âƒ£ <strong>å®®ä½äº”è¡Œ</strong> (èƒŒæ™¯)</div>
            </div>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">1. å››æŸ±
            </h3>
            <p>å³æ‚¨çš„ã€Œå¹´ã€æœˆã€æ—¥ã€æ™‚ã€å…«å­—ã€‚å¥‡é–€æ’ç›¤çš„åŸºç¤åœ¨æ–¼æ™‚é–“ã€‚</p>
            <ul>
                <li><strong>å¹´æŸ±ï¼š</strong> æ¯å¹´ç«‹æ˜¥ï¼ˆç´„2æœˆ4æ—¥ï¼‰ç‚ºåˆ†ç•Œé»ã€‚ç«‹æ˜¥å‰å±¬ä¸Šä¸€å¹´ã€‚</li>
                <li><strong>æœˆæŸ±ï¼š</strong> ä»¥äºŒåå››ç¯€æ°£ç‚ºåˆ†ç•Œï¼ˆå¦‚é©šèŸ„æ›æœˆï¼‰ã€‚</li>
                <li><strong>æ—¥æŸ±ï¼š</strong> æ¯æ—¥23:00ï¼ˆå­æ™‚ï¼‰æ›´æ›æ—¥æŸ±ã€‚</li>
                <li><strong>æ™‚æŸ±ï¼š</strong> æ¯å…©å°æ™‚ç‚ºä¸€å€‹æ™‚è¾°ã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">2. å…«é–€è©³è§£</h3>
            <p>å…«é–€ä»£è¡¨ã€Œäººäº‹ã€ï¼Œæ˜¯åˆ¤æ–·å‰å‡¶çš„é—œéµã€‚</p>
            <ul>
                <li><strong style="color:#f1c40f">é–‹é–€ (å‰)ï¼š</strong> äº”è¡Œå±¬é‡‘ã€‚åˆ©æ–¼é–‹æ¥­ã€ç¶“å•†ã€æ±‚è²¡ã€è€ƒå­¸ã€å‡ºè¡Œã€‚</li>
                <li><strong style="color:#f1c40f">ä¼‘é–€ (å‰)ï¼š</strong> äº”è¡Œå±¬æ°´ã€‚åˆ©æ–¼ä¼‘é¤Šã€æœƒè¦‹è²´äººã€èª¿è§£ç³¾ç´›ã€å©šå§»å«å¨¶ã€‚</li>
                <li><strong style="color:#f1c40f">ç”Ÿé–€ (å‰)ï¼š</strong> äº”è¡Œå±¬åœŸã€‚å¤§å‰ä¹‹é–€ï¼Œåˆ©æ–¼æ±‚è²¡ã€ç‡Ÿé€ ã€æ²»ç—…ã€ç”Ÿç”¢ã€‚</li>
                <li><strong style="color:#e74c3c">å‚·é–€ (å‡¶)ï¼š</strong> äº”è¡Œå±¬æœ¨ã€‚ä¸»å—å‚·ã€è¨å‚µã€è³­åšã€‚ä¸åˆ©ç¶“å•†å‡ºè¡Œã€‚</li>
                <li><strong style="color:#e74c3c">æœé–€ (å¹³/å‡¶)ï¼š</strong> äº”è¡Œå±¬æœ¨ã€‚ä¸»éš±è—ã€ä¿å¯†ã€èº²ç½ã€‚ä¸åˆ©ä¸»å‹•å‡ºæ“Šã€‚</li>
                <li><strong style="color:#e74c3c">æ™¯é–€ (å¹³/å‰)ï¼š</strong> äº”è¡Œå±¬ç«ã€‚ä¸»æ–‡æ›¸ã€è€ƒè©¦ã€è¨Šæ¯ã€‚å°å¿ƒå£èˆŒæ˜¯éã€‚</li>
                <li><strong style="color:#e74c3c">æ­»é–€ (å¤§å‡¶)ï¼š</strong> äº”è¡Œå±¬åœŸã€‚ä¸»å¼”å–ªã€åˆ‘æˆ®ã€‚è«¸äº‹ä¸å®œï¼Œå”¯å®œç‹©çµå¼”å”ã€‚</li>
                <li><strong style="color:#e74c3c">é©šé–€ (å‡¶)ï¼š</strong> äº”è¡Œå±¬é‡‘ã€‚ä¸»é©šæã€å®˜å¸ã€å£èˆŒã€‚å®œå¾‹å¸«è¾¯è­·ï¼Œé¤˜äº‹ä¸å®œã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">3. ä¹æ˜Ÿè©³è§£</h3>
            <p>ä¹æ˜Ÿä»£è¡¨ã€Œå¤©æ™‚ã€ï¼Œå½±éŸ¿å¤§ç’°å¢ƒèˆ‡æ™‚æ©Ÿã€‚</p>
            <ul>
                <li><strong style="color:#e74c3c">å¤©å¿ƒ (å‰)ï¼š</strong> åˆ©æ–¼é†«ç™‚ã€ç®¡ç†ã€ç­–åŠƒã€‚</li>
                <li><strong style="color:#e74c3c">å¤©è¼” (å‰)ï¼š</strong> åˆ©æ–¼æ•™è‚²ã€è€ƒè©¦ã€å‡è·ã€‚</li>
                <li><strong style="color:#e74c3c">å¤©ç¦½ (å¤§å‰)ï¼š</strong> å°Šè²´ä¹‹æ˜Ÿï¼Œç™¾äº‹çš†å‰ã€‚</li>
                <li><strong style="color:#e74c3c">å¤©ä»» (å‰)ï¼š</strong> åˆ©æ–¼ä»»è·ã€è«‡åˆ¤ã€æ±‚è²¡ã€‚</li>
                <li><strong style="color:#e74c3c">å¤©æ²– (å‰/å¹³)ï¼š</strong> åˆ©æ–¼å‡ºå¾ã€é‹å‹•ï¼Œä¸åˆ©å®‰éœä¹‹äº‹ã€‚</li>
                <li><strong style="color:#aaa">å¤©è“¬ (å‡¶)ï¼š</strong> ä¸»ç›œè³Šã€ç ´è²¡ã€æ°´ç½ã€‚</li>
                <li><strong style="color:#aaa">å¤©èŠ® (å‡¶)ï¼š</strong> ç—…æ˜Ÿï¼Œä¸»ç–¾ç—…ã€å•é¡Œæ‰€åœ¨ã€‚</li>
                <li><strong style="color:#aaa">å¤©æŸ± (å‡¶)ï¼š</strong> ä¸»å£èˆŒã€å®˜éã€ç ´å£ã€‚</li>
                <li><strong style="color:#aaa">å¤©è‹± (å¹³)ï¼š</strong> ä¸»è¡€å…‰ã€ç«ç½ï¼Œä¹Ÿä¸»åè²ã€ç¤¾äº¤ã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">4. å…«ç¥è©³è§£</h3>
            <p>å…«ç¥ä»£è¡¨ã€Œç¥åŠ©ã€ï¼Œæ˜¯ä¸å¯è¦‹çš„èƒ½é‡å½±éŸ¿ã€‚</p>
            <ul>
                <li><strong style="color:#3498db">å€¼ç¬¦ (å¤§å‰)ï¼š</strong> çœ¾ç¥ä¹‹é¦–ï¼Œç™¾æƒ¡æ¶ˆæ•£ï¼Œæœ€å‰ä¹‹ç¥ã€‚</li>
                <li><strong style="color:#3498db">é¨°è›‡ (å‡¶)ï¼š</strong> ä¸»è™›é©šæ€ªç•°ã€åè¦†ç„¡å¸¸ã€å¤¢é­˜ã€‚</li>
                <li><strong style="color:#3498db">å¤ªé™° (å‰)ï¼š</strong> ä¸»å¯†è¬€ã€ç­–åŠƒã€é™°ä½‘ã€éš±è”½ã€‚</li>
                <li><strong style="color:#3498db">å…­åˆ (å‰)ï¼š</strong> ä¸»å©šå§»ã€äº¤æ˜“ã€ä»²ä»‹ã€åˆä½œã€‚</li>
                <li><strong style="color:#3498db">ç™½è™ (å¤§å‡¶)ï¼š</strong> ä¸»è¡€å…‰ã€è»Šç¦ã€åˆ‘å‚·ã€çˆ­é¬¥ã€‚</li>
                <li><strong style="color:#3498db">ç„æ­¦ (å‡¶)ï¼š</strong> ä¸»ç›œç«Šã€å£èˆŒã€å°äººã€æ›–æ˜§ã€‚</li>
                <li><strong style="color:#3498db">ä¹åœ° (å‰)ï¼š</strong> ä¸»å±¯å…µã€åŸ‹ä¼ã€é•·ä¹…ã€å®‰éœã€‚</li>
                <li><strong style="color:#3498db">ä¹å¤© (å‰)ï¼š</strong> ä¸»æšå…µã€é è¡Œã€åè²ã€å‹•æ…‹ã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">5. åå¤©å¹²</h3>
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 20px;">
                <thead>
                    <tr style="border-bottom: 1px solid #555; color: var(--accent-gold);">
                        <th style="padding: 5px; text-align: left;">å¤©å¹²</th>
                        <th style="padding: 5px; text-align: left;">é™°é™½</th>
                        <th style="padding: 5px; text-align: left;">äº”è¡Œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 5px;">ç”²</td>
                        <td style="padding: 5px;">é™½</td>
                        <td style="padding: 5px;">æœ¨</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">ä¹™</td>
                        <td style="padding: 5px;">é™°</td>
                        <td style="padding: 5px;">æœ¨</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">ä¸™</td>
                        <td style="padding: 5px;">é™½</td>
                        <td style="padding: 5px;">ç«</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">ä¸</td>
                        <td style="padding: 5px;">é™°</td>
                        <td style="padding: 5px;">ç«</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">æˆŠ</td>
                        <td style="padding: 5px;">é™½</td>
                        <td style="padding: 5px;">åœŸ</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">å·±</td>
                        <td style="padding: 5px;">é™°</td>
                        <td style="padding: 5px;">åœŸ</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">åºš</td>
                        <td style="padding: 5px;">é™½</td>
                        <td style="padding: 5px;">é‡‘</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">è¾›</td>
                        <td style="padding: 5px;">é™°</td>
                        <td style="padding: 5px;">é‡‘</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">å£¬</td>
                        <td style="padding: 5px;">é™½</td>
                        <td style="padding: 5px;">æ°´</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">ç™¸</td>
                        <td style="padding: 5px;">é™°</td>
                        <td style="padding: 5px;">æ°´</td>
                    </tr>
                </tbody>
            </table>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">6. åäºŒåœ°æ”¯</h3>
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 20px;">
                <thead>
                    <tr style="border-bottom: 1px solid #555; color: var(--accent-gold);">
                        <th style="padding: 5px; text-align: left;">åœ°æ”¯</th>
                        <th style="padding: 5px; text-align: left;">ç”Ÿè‚–</th>
                        <th style="padding: 5px; text-align: left;">äº”è¡Œ</th>
                        <th style="padding: 5px; text-align: left;">æ–¹ä½</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 5px;">å­</td>
                        <td style="padding: 5px;">é¼ </td>
                        <td style="padding: 5px;">æ°´</td>
                        <td style="padding: 5px;">åŒ—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">ä¸‘</td>
                        <td style="padding: 5px;">ç‰›</td>
                        <td style="padding: 5px;">åœŸ</td>
                        <td style="padding: 5px;">æ±åŒ—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">å¯…</td>
                        <td style="padding: 5px;">è™</td>
                        <td style="padding: 5px;">æœ¨</td>
                        <td style="padding: 5px;">æ±åŒ—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">å¯</td>
                        <td style="padding: 5px;">å…”</td>
                        <td style="padding: 5px;">æœ¨</td>
                        <td style="padding: 5px;">æ±</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">è¾°</td>
                        <td style="padding: 5px;">é¾</td>
                        <td style="padding: 5px;">åœŸ</td>
                        <td style="padding: 5px;">æ±å—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">å·³</td>
                        <td style="padding: 5px;">è›‡</td>
                        <td style="padding: 5px;">ç«</td>
                        <td style="padding: 5px;">æ±å—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">åˆ</td>
                        <td style="padding: 5px;">é¦¬</td>
                        <td style="padding: 5px;">ç«</td>
                        <td style="padding: 5px;">å—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">æœª</td>
                        <td style="padding: 5px;">ç¾Š</td>
                        <td style="padding: 5px;">åœŸ</td>
                        <td style="padding: 5px;">è¥¿å—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">ç”³</td>
                        <td style="padding: 5px;">çŒ´</td>
                        <td style="padding: 5px;">é‡‘</td>
                        <td style="padding: 5px;">è¥¿å—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">é…‰</td>
                        <td style="padding: 5px;">é›</td>
                        <td style="padding: 5px;">é‡‘</td>
                        <td style="padding: 5px;">è¥¿</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">æˆŒ</td>
                        <td style="padding: 5px;">ç‹—</td>
                        <td style="padding: 5px;">åœŸ</td>
                        <td style="padding: 5px;">è¥¿åŒ—</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;">äº¥</td>
                        <td style="padding: 5px;">è±¬</td>
                        <td style="padding: 5px;">æ°´</td>
                        <td style="padding: 5px;">è¥¿åŒ—</td>
                    </tr>
                </tbody>
            </table>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">7. åäºŒæ™‚è¾°å®œå¿Œ</h3>
            <div style="font-size: 0.9rem; line-height: 1.6;">
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">å­æ™‚ï¼ˆ23:00 â€“ 01:00ï¼‰â€”â€”å±¬æ°´ï¼Œé™°æ°£æœ€ç››</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> éœå¿ƒã€å†¥æƒ³ã€æ´—æ»Œã€æ·¨åŒ–ã€æ§‹æ€ã€å¯«ä½œ<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> æ¿€çƒˆé‹å‹•ã€å¤§åµå¤§é¬§ã€æƒ…ç·’çˆ†ç™¼ã€é£²é…’éé‡
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">ä¸‘æ™‚ï¼ˆ01:00 â€“ 03:00ï¼‰â€”â€”å±¬åœŸï¼Œé¤Šç²¾è“„éŠ³</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> ç†Ÿç¡ã€é¤Šè‚æ’æ¯’ï¼ˆå‚³çµ±è§€å¿µï¼‰ã€é–±è®€ã€å®‰éœæ´»å‹•<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> ç†¬å¤œå·¥ä½œã€é‡å£å‘³é£²é£Ÿ
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">å¯…æ™‚ï¼ˆ03:00 â€“ 05:00ï¼‰â€”â€”å±¬æœ¨ï¼Œé™½æ°£åˆç”Ÿ</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> æº–å‚™æ–°è¨ˆç•«ã€ç¥ˆç¦ã€éœåã€æ—©èµ·é‹å‹•ï¼ˆè¼•åº¦ï¼‰<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> é«˜å£“å·¥ä½œã€å¤§é‡å’–å•¡å› 
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">å¯æ™‚ï¼ˆ05:00 â€“ 07:00ï¼‰â€”â€”å±¬æœ¨ï¼Œä¸€æ—¥é–‹å§‹</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> æ—©èµ·ã€ä¼¸å±•ã€æ•£æ­¥ã€åˆ¶å®šä»Šæ—¥ç›®æ¨™<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> è³´åºŠï¼ˆä¾å‚³çµ±èªªæ³•æœƒå£“é‹ï¼‰ã€æš´é£²æš´é£Ÿçš„æ—©é¤
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">è¾°æ™‚ï¼ˆ07:00 â€“ 09:00ï¼‰â€”â€”å±¬åœŸï¼Œæ´»åŠ›ä¸Šå‡</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> ä¸Šå·¥ã€è®€æ›¸ã€é–‹æœƒã€è«‡åˆä½œã€æå‡å°ˆæ³¨åŠ›çš„äº‹<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> é²åˆ°ã€æ‹–å»¶é‡è¦äº‹å‹™
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">å·³æ™‚ï¼ˆ09:00 â€“ 11:00ï¼‰â€”â€”å±¬ç«ï¼Œæ•ˆç‡æœ€ä½³</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> é¢è©¦ã€æ¥­å‹™è«‡åˆ¤ã€é‡è¦æ±ºå®š<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> æƒ…ç·’æ€§æ±ºç­–ã€éåº¦æ‰¿è«¾
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">åˆæ™‚ï¼ˆ11:00 â€“ 13:00ï¼‰â€”â€”å±¬ç«ï¼Œé™½æ¥µè€Œç”Ÿé™°</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> ç”¨é¤ã€é©åº¦ä¼‘æ¯ã€æš«åœå·¥ä½œ<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> é•·æ™‚é–“æ›æ›¬ã€éåº¦æ“å‹
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">æœªæ™‚ï¼ˆ13:00 â€“ 15:00ï¼‰â€”â€”å±¬åœŸï¼Œèº«å¿ƒéæ¸¡æœŸ</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> æ”¾é¬†ã€å‰µæ„ç™¼æƒ³ã€ç·©æ­¥é‹å‹•<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> ç·Šæ€¥é‡è¦è«‡åˆ¤ã€æƒ…ç·’è¡å‹•
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">ç”³æ™‚ï¼ˆ15:00 â€“ 17:00ï¼‰â€”â€”å±¬é‡‘ï¼Œè…¦åŠ›å›å‡</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> è™•ç†è¤‡é›œå•é¡Œã€æ–‡ä»¶ã€åˆ†æã€å¯«ä½œã€å•†æ¥­äº¤æ˜“<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> é›£ä»¥é›†ä¸­ç²¾ç¥è€…é¿å…é‡ä»»
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">é…‰æ™‚ï¼ˆ17:00 â€“ 19:00ï¼‰â€”â€”å±¬é‡‘ï¼Œæ”¶æ–‚</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> ç”¨é¤ã€å®¶åº­æ´»å‹•ã€åæ€ä»Šå¤©<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> éåº¦åŠ ç­ã€é«˜æ²¹è„‚é£²é£Ÿ
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">æˆŒæ™‚ï¼ˆ19:00 â€“ 21:00ï¼‰â€”â€”å±¬åœŸï¼Œé©åˆæ²‰æ¾±</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> å­¸ç¿’ã€è®€æ›¸ã€ç™‚ç™’é¡æ´»å‹•ã€æ•´ç†ç’°å¢ƒ<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> éåº¦å¨›æ¨‚ã€æƒ…ç·’æ¶ˆè€—
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">äº¥æ™‚ï¼ˆ21:00 â€“ 23:00ï¼‰â€”â€”å±¬æ°´ï¼Œæ”¶å¿ƒå®‰ç¥</strong><br>
                    <span style="color: #27ae60;">å®œï¼š</span> æ”¾é¬†ã€å†¥æƒ³ã€ç¡å‰æº–å‚™ã€éœæ…‹ä¼‘é–’<br>
                    <span style="color: #c0392b;">å¿Œï¼š</span> è—å…‰åˆºæ¿€ã€å¤§é‡é€²é£Ÿ
                </div>
            </div>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">8. ä¹å®®å…«å¦</h3>
            <p>ä¹å®®ä»£è¡¨ã€Œåœ°åˆ©ã€ï¼Œæ˜¯ç›¤é¢çš„åŸºç¤æ–¹ä½èˆ‡äº”è¡Œå±¬æ€§ã€‚</p>
            <ul>
                <li><strong>åä¸€ (åŒ—/æ°´)ï¼š</strong> æ™ºæ…§ã€æµå‹•ã€é™·é˜±ã€‚</li>
                <li><strong>å¤äºŒ (è¥¿å—/åœŸ)ï¼š</strong> åŒ…å®¹ã€å¤§åœ°ã€ç·©æ…¢ã€‚</li>
                <li><strong>éœ‡ä¸‰ (æ±/æœ¨)ï¼š</strong> å•Ÿå‹•ã€è¡æ“Šã€ç™¼ç”Ÿã€‚</li>
                <li><strong>å·½å›› (æ±å—/æœ¨)ï¼š</strong> äº¤æ˜“ã€åˆ©å¸‚ã€ä¸ç©©ã€‚</li>
                <li><strong>ä¸­äº” (ä¸­/åœŸ)ï¼š</strong> æ ¸å¿ƒã€æ¥µé» (å¯„æ–¼å¤äºŒæˆ–è‰®å…«)ã€‚</li>
                <li><strong>ä¹¾å…­ (è¥¿åŒ—/é‡‘)ï¼š</strong> æ¬ŠåŠ›ã€é ˜å°ã€å‰›å¥ã€‚</li>
                <li><strong>å…Œä¸ƒ (è¥¿/é‡‘)ï¼š</strong> å£èˆŒã€ç¼ºæã€è®Šé©ã€‚</li>
                <li><strong>è‰®å…« (æ±åŒ—/åœŸ)ï¼š</strong> åœæ­¢ã€é˜»éš”ã€é å±±ã€‚</li>
                <li><strong>é›¢ä¹ (å—/ç«)ï¼š</strong> æ–‡æ›¸ã€é¡¯çœ¼ã€è™›å¹»ã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">9. å±€æ•¸èˆ‡ç¯€æ°£</h3>
            <p>å¥‡é–€éç”²åˆ†ç‚ºã€Œé™½éã€èˆ‡ã€Œé™°éã€ï¼Œå…±18å±€ã€‚</p>
            <ul>
                <li><strong>é™½éï¼š</strong> å†¬è‡³å¾Œè‡³å¤è‡³å‰ï¼ˆèƒ½é‡ä¸Šå‡æœŸï¼‰ã€‚</li>
                <li><strong>å±€æ•¸ï¼š</strong> æ ¹æ“šç•¶æ—¥çš„ç¯€æ°£èˆ‡æ—¥å¹²æ”¯è¨ˆç®—ï¼Œæ±ºå®šäº†å±€é¢çš„åŸºæœ¬æ¶æ§‹ã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">10. æ—¬é¦–</h3>
            <p>ã€Œæ—¬ã€æ˜¯10å€‹æ™‚è¾°çš„é€±æœŸï¼Œã€Œæ—¬é¦–ã€æ˜¯é€™10å€‹æ™‚è¾°çš„é ˜éšŠï¼ˆä¸€å®šæ˜¯ç”²ï¼‰ã€‚<br>
                ä¾‹å¦‚ï¼šç”²å­æ—¬çš„10å€‹æ™‚è¾°å…§ï¼Œæ—¬é¦–éƒ½æ˜¯ã€Œç”²å­ï¼ˆæˆŠï¼‰ã€ã€‚<br>
                <strong>ä½œç”¨ï¼š</strong> æ—¬é¦–æ±ºå®šäº†ã€Œå€¼ç¬¦ï¼ˆå¤§å°‡ï¼‰ã€èˆ‡ã€Œå€¼ä½¿ï¼ˆå‚³ä»¤å®˜ï¼‰ã€çš„ä½ç½®ï¼Œæ˜¯æ’ç›¤çš„æ ¸å¿ƒã€‚
            </p>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">11. å¤©åœ°ç›¤å¹²è§£è®€</h3>
            <p>å·¦ä¸‹è§’çš„å…©å€‹å­—ï¼ˆä¸Šç‚ºå¤©ç›¤ï¼Œä¸‹ç‚ºåœ°ç›¤ï¼‰æ˜¯åˆ¤æ–·å‰å‡¶çš„é‡è¦ä¾æ“šã€‚</p>
            <ul>
                <li><strong>åœ°ç›¤å¤©å¹² (ä¸‹)ï¼š</strong> äº‹æƒ…çš„æœ¬è³ªï¼ˆå›ºå®šï¼‰ã€‚ä»£è¡¨äº‹ä»¶æœ¬é«”ã€æ ¹æœ¬ç‹€æ³èˆ‡çœŸå¯¦é¢ã€‚</li>
                <li><strong>å¤©ç›¤å¤©å¹² (ä¸Š)ï¼š</strong> äº‹æƒ…çš„è®ŠåŒ–ï¼ˆå‹•æ…‹ï¼‰ã€‚ä»£è¡¨å¤–åœ¨å› ç´ ã€ç¾åœ¨çš„æƒ…æ³ï¼Œä»¥åŠçµæœè¶¨å‹¢ã€‚</li>
            </ul>
            <p><strong>å¤©å¹²ç›¸ç”Ÿç›¸å‰‹ï¼ˆå‰å‡¶åˆ¤æ–·æ ¸å¿ƒï¼‰ï¼š</strong></p>
            <ul>
                <li><span style="color:#27ae60;">å¤©ç›¤ ç”Ÿ åœ°ç›¤</span> â†’ <strong>é †åˆ©ã€åŠ©åŠ›</strong> (å¤–åœ¨ç’°å¢ƒå¹«åŠ©æœ¬é«”)</li>
                <li><span style="color:#e74c3c;">å¤©ç›¤ å‰‹ åœ°ç›¤</span> â†’ <strong>é˜»ç¤™ã€éº»ç…©ã€å£“åŠ›</strong> (å¤–åœ¨ç’°å¢ƒå£“è¿«æœ¬é«”)</li>
                <li><span style="color:#f39c12;">åœ°ç›¤ ç”Ÿ å¤©ç›¤</span> â†’ <strong>æ¶ˆè€—ã€è²»åŠ›</strong> (æœ¬é«”éœ€ä»˜å‡ºä»¥æ”¯æ’å¤–åœ¨)</li>
                <li><span style="color:#3498db;">åœ°ç›¤ å‰‹ å¤©ç›¤</span> â†’ <strong>ä¸»å°æ¬Š</strong> (æœ¬é«”èƒ½å£“ä½æƒ…å‹¢ï¼Œé›–æœ‰æŒ‘æˆ°ä½†èƒ½æŒæ§)</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">12. ç›¤é¢è§£è®€</h3>
            <p>ä¹å®®æ ¼ä¸­ï¼Œæ¯ä¸€æ ¼ï¼ˆå®®ï¼‰ä»£è¡¨ä¸€å€‹æ–¹ä½ã€‚çœ‹ç›¤é‡é»ï¼š</p>
            <ul>
                <li><span style="color:#3498db">å…«ç¥ (é ‚éƒ¨è—å­—)</span>ï¼šç¥åŠ©åŠ›é‡ã€‚<strong>å€¼ç¬¦</strong>æœ€å‰ã€‚</li>
                <li><span style="color:#e74c3c">ä¹æ˜Ÿ (ä¸­é–“ç´…å­—)</span>ï¼šå¤©æ™‚åœ°åˆ©ã€‚</li>
                <li><span style="color:#f1c40f">å…«é–€ (ä¸­é–“é»ƒå­—)</span>ï¼šäººäº‹è¡Œå‹•ã€‚</li>
                <li><span style="color:#ccc">å¤©åœ°ç›¤å¹² (å³ä¸‹è§’)</span>ï¼šä¸Šå­—ç‚ºå¤©ç›¤ï¼Œä¸‹å­—ç‚ºåœ°ç›¤ã€‚</li>
            </ul>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">13. ç”²æ™‚</h3>
            <p>æ¯æ—¥æœ‰12å€‹æ™‚è¾°ï¼Œå…¶ä¸­å¤©å¹²ç‚ºã€Œç”²ã€çš„æ™‚è¾°ç¨±ç‚ºç”²æ™‚ï¼ˆå¦‚ç”²å­æ™‚ã€ç”²æˆŒæ™‚...ï¼‰ã€‚<br>
                æ­¤æ™‚è¾°æ˜¯èƒ½é‡é‡å•Ÿçš„æ™‚åˆ»ï¼Œä¹Ÿæ˜¯ã€Œæ—¬é¦–ã€è®Šæ›çš„æ™‚åˆ»ï¼Œé©åˆé€²è¡Œé‡è¦çš„å•Ÿå‹•å„€å¼æˆ–æ±ºç­–ã€‚</p>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">14. ç¾…ç›¤æ¨¡å¼</h3>
            <p>é»æ“Šã€Œå•Ÿç”¨ç¾…ç›¤ã€å¾Œï¼Œå¹³æ”¾æ‰‹æ©Ÿã€‚ç›¤é¢æœƒè‡ªå‹•æ—‹è½‰ï¼Œä½¿ç›¤ä¸Šçš„ã€Œå—ã€å°æº–çœŸå¯¦çš„å—æ–¹ã€‚<br>
                <strong>æ³¨æ„ï¼š</strong> iOS éœ€åœ¨ HTTPS ç’°å¢ƒä¸‹ä½¿ç”¨ã€‚
            </p>

            <h3 style="color:var(--accent-gold); border-bottom:1px solid #444; padding-bottom:5px;">15. ç‰¹æ®Šæ¨™ç¤ºèªªæ˜</h3>
            <p>ç›¤é¢ä¸Šå¯èƒ½å‡ºç¾çš„å°æ¨™ç±¤ï¼š</p>
            <ul>
                <li><span
                        style="background-color:#c0392b; color:white; padding:1px 3px; border-radius:3px; font-size:0.8rem;">åˆ‘</span>
                    <strong>æ“Šåˆ‘ï¼š</strong> å¤©ç›¤å¹²èˆ‡åœ°ç›¤å®®ä½å½¢æˆç›¸åˆ‘ã€‚ä»£è¡¨æ¥µåº¦é›£å—ã€å½†æ‰­ã€å—æŠ˜ç£¨ã€‚
                </li>
                <li><span
                        style="background-color:#7f8c8d; color:white; padding:1px 3px; border-radius:3px; font-size:0.8rem;">å¢“</span>
                    <strong>å…¥å¢“ï¼š</strong> å¤©ç›¤å¹²é€²å…¥å¢“åº«å®®ä½ã€‚ä»£è¡¨èƒ½é‡è¢«å›°ä½ã€ç™¼æ®ä¸å‡ºä¾†ã€ç„¡åŠ›ã€‚
                </li>
                <li><span
                        style="background-color:#d35400; color:white; padding:1px 3px; border-radius:3px; font-size:0.8rem;">è¿«</span>
                    <strong>é–€è¿«ï¼š</strong> é–€çš„äº”è¡Œå‰‹å®®ä½äº”è¡Œã€‚ä»£è¡¨è©²é–€çš„å‰å‡¶èƒ½é‡è¢«æ‰“æŠ˜ï¼Œç”šè‡³è½‰å‡¶ (å‰é–€ä¸å‰ï¼Œå‡¶é–€æ›´å‡¶)ã€‚
                </li>
                <li style="margin-top:8px;"><strong>å®®ä½é ‚ç«¯æ¨™ç±¤ (å¤©åœ°ç›¤é—œä¿‚)ï¼š</strong>
                    <div style="margin-top:5px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <div><span
                                style="background-color:rgba(39, 174, 96, 0.8); color:white; padding:1px 4px; border-radius:3px; font-size:0.6rem;">å¤©ç”Ÿ</span>
                            åŠ©åŠ›å¤§ï¼Œé †åˆ©</div>
                        <div><span
                                style="background-color:rgba(192, 57, 43, 0.8); color:white; padding:1px 4px; border-radius:3px; font-size:0.6rem;">å¤©å‰‹</span>
                            å£“åŠ›å¤§ï¼Œé˜»ç¤™</div>
                        <div><span
                                style="background-color:rgba(243, 156, 18, 0.8); color:white; padding:1px 4px; border-radius:3px; font-size:0.6rem;">åœ°ç”Ÿ</span>
                            éœ€ä»˜å‡ºï¼Œè¼ƒç´¯</div>
                        <div><span
                                style="background-color:rgba(41, 128, 185, 0.8); color:white; padding:1px 4px; border-radius:3px; font-size:0.6rem;">åœ°å‰‹</span>
                            èƒ½æŒæ§ï¼Œä¸»å°</div>
                        <div><span
                                style="background-color:rgba(127, 140, 141, 0.8); color:white; padding:1px 4px; border-radius:3px; font-size:0.6rem;">æ¯”å’Œ</span>
                            å¹³ç©©ï¼Œå’Œè«§</div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div style="height: 20px; width: 100%;"></div>

    <footer>

    </footer>
    </div>

    <script>

        // åœ¨æª”æ¡ˆé ‚ç«¯åŠ 
        let lastRiskScore = 0;
        // --- Constants & Data ---
        const TIAN_GAN = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
        const DI_ZHI = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
        const BA_GUA = ['å', 'å¤', 'éœ‡', 'å·½', 'ä¸­', 'ä¹¾', 'å…Œ', 'è‰®', 'é›¢'];
        const LUO_SHU = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
        const PALACE_MAP = {
            4: 0, 9: 1, 2: 2,
            3: 3, 5: 4, 7: 5,
            8: 6, 1: 7, 6: 8
        };
        const PALACE_NAMES = {
            1: 'åä¸€', 2: 'å¤äºŒ', 3: 'éœ‡ä¸‰', 4: 'å·½å››', 5: 'ä¸­äº”', 6: 'ä¹¾å…­', 7: 'å…Œä¸ƒ', 8: 'è‰®å…«', 9: 'é›¢ä¹'
        };
        const DIRECTION_NAMES = {
            1: 'åŒ—', 2: 'è¥¿å—', 3: 'æ±', 4: 'æ±å—', 5: 'ä¸­', 6: 'è¥¿åŒ—', 7: 'è¥¿', 8: 'æ±åŒ—', 9: 'å—'
        };

        const JIA_ZI = [];
        for (let i = 0; i < 60; i++) JIA_ZI.push(TIAN_GAN[i % 10] + DI_ZHI[i % 12]);

        const NINE_STARS = ['å¤©è“¬', 'å¤©èŠ®', 'å¤©æ²–', 'å¤©è¼”', 'å¤©ç¦½', 'å¤©å¿ƒ', 'å¤©æŸ±', 'å¤©ä»»', 'å¤©è‹±'];
        const ORIGIN_STARS = {
            1: 'å¤©è“¬', 2: 'å¤©èŠ®', 3: 'å¤©æ²–', 4: 'å¤©è¼”', 5: 'å¤©ç¦½', 6: 'å¤©å¿ƒ', 7: 'å¤©æŸ±', 8: 'å¤©ä»»', 9: 'å¤©è‹±'
        };
        const STAR_RING = ['å¤©è“¬', 'å¤©ä»»', 'å¤©æ²–', 'å¤©è¼”', 'å¤©è‹±', 'å¤©èŠ®', 'å¤©æŸ±', 'å¤©å¿ƒ'];

        const EIGHT_DOORS = ['ä¼‘é–€', 'æ­»é–€', 'å‚·é–€', 'æœé–€', 'é–‹é–€', 'é©šé–€', 'ç”Ÿé–€', 'æ™¯é–€'];
        const ORIGIN_DOORS = {
            1: 'ä¼‘é–€', 2: 'æ­»é–€', 3: 'å‚·é–€', 4: 'æœé–€', 6: 'é–‹é–€', 7: 'é©šé–€', 8: 'ç”Ÿé–€', 9: 'æ™¯é–€'
        };
        const DOOR_RING = ['ä¼‘é–€', 'ç”Ÿé–€', 'å‚·é–€', 'æœé–€', 'æ™¯é–€', 'æ­»é–€', 'é©šé–€', 'é–‹é–€'];

        const EIGHT_GODS = ['å€¼ç¬¦', 'é¨°è›‡', 'å¤ªé™°', 'å…­åˆ', 'ç™½è™', 'ç„æ­¦', 'ä¹åœ°', 'ä¹å¤©'];

        const SOLAR_TERMS_C_21 = [
            3.87, 18.73, 5.63, 20.646, 4.81, 20.1, 5.52, 21.04, 5.678, 21.37, 7.108, 22.83,
            7.5, 23.13, 7.646, 23.042, 8.318, 23.438, 7.438, 22.36, 7.18, 21.94, 5.4055, 20.12
        ];
        const SOLAR_TERMS_NAME = [
            "ç«‹æ˜¥", "é›¨æ°´", "é©šèŸ„", "æ˜¥åˆ†", "æ¸…æ˜", "ç©€é›¨", "ç«‹å¤", "å°æ»¿", "èŠ’ç¨®", "å¤è‡³", "å°æš‘", "å¤§æš‘",
            "ç«‹ç§‹", "è™•æš‘", "ç™½éœ²", "ç§‹åˆ†", "å¯’éœ²", "éœœé™", "ç«‹å†¬", "å°é›ª", "å¤§é›ª", "å†¬è‡³", "å°å¯’", "å¤§å¯’"
        ];

        const JU_SHU_MAP = [
            [8, 5, 2], [9, 6, 3], [1, 7, 4], [3, 9, 6], [4, 1, 7], [5, 2, 8],
            [4, 1, 7], [5, 2, 8], [6, 3, 9], [9, 3, 6], [8, 2, 5], [7, 1, 4],
            [2, 5, 8], [1, 4, 7], [9, 3, 6], [7, 1, 4], [6, 9, 3], [5, 8, 2],
            [6, 9, 3], [5, 8, 2], [4, 7, 1], [1, 7, 4], [2, 8, 5], [3, 9, 6]
        ];

        const PALACE_ELEMENTS = { 1: 'æ°´', 2: 'åœŸ', 3: 'æœ¨', 4: 'æœ¨', 5: 'åœŸ', 6: 'é‡‘', 7: 'é‡‘', 8: 'åœŸ', 9: 'ç«' };
        const STEM_ELEMENTS = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };
        const PALACE_BRANCHES = {
            1: [0],
            8: [1, 2],
            3: [3],
            4: [4, 5],
            9: [6],
            2: [7, 8],
            7: [9],
            6: [10, 11]
        };

        let currentState = {
            date: new Date(),
            solarTime: new Date(),
            location: null,
            chart: null
        };

        // --- Astronomical Calculation Helpers (Meeus Simplified) ---
        function getJulianDate(date) {
            return (date.getTime() / 86400000) + 2440587.5;
        }

        function getJulianCentury(date) {
            const JD = getJulianDate(date);
            return (JD - 2451545.0) / 36525.0;
        }

        function toRad(deg) { return deg * Math.PI / 180.0; }
        function toDeg(rad) { return rad * 180.0 / Math.PI; }

        function getSolarApparentLongitude(date) {
            const T = getJulianCentury(date);

            // Mean Longitude (L0)
            let L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
            L0 = L0 % 360;
            if (L0 < 0) L0 += 360;

            // Mean Anomaly (M)
            let M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
            M = M % 360;
            if (M < 0) M += 360;
            const Mrad = toRad(M);

            // Equation of Center (C)
            const C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(Mrad)
                + (0.019993 - 0.000101 * T) * Math.sin(2 * Mrad)
                + 0.000289 * Math.sin(3 * Mrad);

            // True Longitude
            const trueLong = L0 + C;

            // Aberration & Nutation (Simplified)
            const Omega = 125.04 - 1934.136 * T;
            const apparent = trueLong - 0.00569 - 0.00478 * Math.sin(toRad(Omega));

            return (apparent % 360 + 360) % 360;
        }

        // Get Solar Term Index based on exact time (0 = Lichun/315deg)
        function getSolarTerm(date) {
            const L = getSolarApparentLongitude(date);
            // Lichun is at 315 degrees.
            // We want index 0 for [315, 330), index 1 for [330, 345)...
            // Formula: ((L - 315 + 360) % 360) / 15
            let offset = (L - 315 + 360) % 360;
            return Math.floor(offset / 15);
        }

        // Find exact transition time for a specific term index in a given year
        function getTermTransitionDate(year, termIdx) {
            // Target angle: termIdx 0 (Lichun) -> 315
            let targetAngle = (315 + termIdx * 15) % 360;

            // Approx dates for initial guess (Month, Day)
            // 0:Lichun(Feb), ... 22:Xiaohan(Jan), 23:Dahan(Jan)
            const approxDates = [
                [2, 4], [2, 19], [3, 6], [3, 21], [4, 5], [4, 20],
                [5, 6], [5, 21], [6, 6], [6, 21], [7, 7], [7, 23],
                [8, 8], [8, 23], [9, 8], [9, 23], [10, 8], [10, 23],
                [11, 7], [11, 22], [12, 7], [12, 22], [1, 6], [1, 20]
            ];
            const [m, d] = approxDates[termIdx];

            // Construct search date. 
            // Note: For terms 22(Xiaohan) and 23(Dahan), they are in Jan.
            // If we pass year 2024, term 22, we mean Jan 2024.
            // If we pass year 2024, term 0, we mean Feb 2024.
            let searchDate = new Date(year, m - 1, d, 12, 0, 0);

            // Iterative refinement
            for (let i = 0; i < 10; i++) {
                const L = getSolarApparentLongitude(searchDate);
                let diff = L - targetAngle;
                // Handle wrap around 360
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;

                if (Math.abs(diff) < 0.0005) break; // ~1 min precision

                // Rate: Sun moves ~0.9856 deg/day
                const daysDelta = diff / 0.9856;
                searchDate = new Date(searchDate.getTime() - daysDelta * 86400000);
            }
            return searchDate;
        }

        function getJuShu(date, solarTermIdx, dayGanZhiIdx) {
            // 1. åˆ¤æ–·é™°é™½é
            // å†¬è‡³(21) ~ èŠ’ç¨®(8) ç‚ºé™½é
            // å¤è‡³(9) ~ å¤§é›ª(20) ç‚ºé™°é
            let isYang = true;
            let safeTermIdx = solarTermIdx % 24;
            if (safeTermIdx >= 9 && safeTermIdx <= 20) isYang = false;

            // 2. ç¬¦é ­+å·±æ—¥æ›å±€æ³• (Fu Tou + Ji Day Shift Logic)

            // A. æ‰¾ç¬¦é ­ (Find Head of Xun)
            // dayGanZhiIdx æ˜¯ 0-59 çš„æ—¥æŸ±ç´¢å¼•
            const fuTouIdx = dayGanZhiIdx - (dayGanZhiIdx % 10);
            const fuTouBranch = fuTouIdx % 12; // ç¬¦é ­çš„åœ°æ”¯ (åªæœƒæ˜¯ å­0, å¯…2, è¾°4, åˆ6, ç”³8, æˆŒ10)

            // B. å®šç¬¦é ­çš„åŸå§‹ä¸‰å…ƒ (Base Yuan) - ä¿®æ­£å¾Œçš„æ­£ç¢ºé †åº
            // è¦å‰‡ï¼šå­åˆ=ä¸Š, å¯…ç”³=ä¸­, è¾°æˆŒ=ä¸‹
            let baseYuan = 0;

            if (fuTouBranch === 0 || fuTouBranch === 6) {
                baseYuan = 0; // ç”²å­ã€ç”²åˆ -> ä¸Šå…ƒ
            } else if (fuTouBranch === 2 || fuTouBranch === 8) {
                baseYuan = 1; // ç”²å¯…ã€ç”²ç”³ -> ä¸­å…ƒ
            } else {
                baseYuan = 2; // ç”²è¾°ã€ç”²æˆŒ -> ä¸‹å…ƒ (é€™ä¿®å¾©äº†11/05çš„å•é¡Œ)
            }

            // C. åˆ¤æ–·æ˜¯å¦ç‚ºå¾ŒåŠæ—¬ (å·±~ç™¸)
            // å¤©å¹²ç´¢å¼•ï¼š0=ç”², 4=æˆŠ, 5=å·±, 9=ç™¸
            const dayStem = dayGanZhiIdx % 10;
            let currentYuan = baseYuan;

            if (dayStem >= 5) {
                // å·±æ—¥ä»¥å¾Œï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€å€‹å…ƒ (Cycle: 0->1->2->0)
                currentYuan = (baseYuan + 1) % 3;
            }

            // 3. å–å±€æ•¸
            const bureaus = JU_SHU_MAP[safeTermIdx];
            if (!bureaus) return { isYang: true, ju: 1 };

            return { isYang: isYang, ju: bureaus[currentYuan] };
        }

        function calculateChart(date, solarTime) {
            const yearIdx = getGanZhiYear(solarTime);
            const monthIdx = getGanZhiMonth(solarTime, yearIdx);
            const dayIdx = getGanZhiDay(solarTime);
            const hourIdx = getGanZhiHour(solarTime, dayIdx);

            const termIdx = getSolarTerm(solarTime);
            const { isYang, ju } = getJuShu(solarTime, termIdx, dayIdx);
            const jiPalace = isYang ? 8 : 2;

            const STEM_ORDER = ['æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ä¸', 'ä¸™', 'ä¹™'];
            let diPan = {};

            for (let i = 0; i < 9; i++) {
                let stem = STEM_ORDER[i];
                let palace;
                if (isYang) {
                    let p = (ju + i);
                    while (p > 9) p -= 9;
                    palace = p;
                } else {
                    let p = (ju - i);
                    while (p < 1) p += 9;
                    palace = p;
                }
                diPan[palace] = stem;
            }

            const xunShouStr = getXunShou(hourIdx);
            const XUN_MAP = {
                'ç”²å­': 'æˆŠ', 'ç”²æˆŒ': 'å·±', 'ç”²ç”³': 'åºš',
                'ç”²åˆ': 'è¾›', 'ç”²è¾°': 'å£¬', 'ç”²å¯…': 'ç™¸'
            };
            const leaderStem = XUN_MAP[xunShouStr];

            let leaderPalace = 0;
            for (let p in diPan) {
                if (diPan[p] === leaderStem) {
                    leaderPalace = parseInt(p);
                    break;
                }
            }

            const hourGan = hourIdx % 10;
            let targetStem = TIAN_GAN[hourGan];
            if (targetStem === 'ç”²') targetStem = leaderStem;

            let hourPalace = 0;
            for (let p in diPan) {
                if (diPan[p] === targetStem) {
                    hourPalace = parseInt(p);
                    break;
                }
            }
            if (hourPalace === 5) hourPalace = jiPalace;

            const originStarName = ORIGIN_STARS[leaderPalace === 5 ? jiPalace : leaderPalace];
            const startIdx = STAR_RING.indexOf(originStarName);
            const PALACE_TO_RING = { 1: 0, 8: 1, 3: 2, 4: 3, 9: 4, 2: 5, 7: 6, 6: 7 };
            const targetRingIdx = PALACE_TO_RING[hourPalace];

            let offset = targetRingIdx - startIdx;
            if (offset < 0) offset += 8;

            let tianPan = {};
            let tianPanStems = {};

            for (let i = 0; i < 8; i++) {
                const star = STAR_RING[i];
                const newRingIdx = (i + offset) % 8;
                const RING_TO_PALACE = [1, 8, 3, 4, 9, 2, 7, 6];
                const p = RING_TO_PALACE[newRingIdx];
                tianPan[p] = star;
                const originalP = RING_TO_PALACE[i];
                tianPanStems[p] = diPan[originalP];
            }

            const originDoorName = ORIGIN_DOORS[leaderPalace === 5 ? jiPalace : leaderPalace];
            let doorStartP = leaderPalace;
            if (doorStartP === 5) doorStartP = jiPalace;

            let steps = hourIdx % 10;
            let zhiShiP = doorStartP;
            if (isYang) {
                zhiShiP = (doorStartP + steps);
                while (zhiShiP > 9) zhiShiP -= 9;
            } else {
                zhiShiP = (doorStartP - steps);
                while (zhiShiP < 1) zhiShiP += 9;
            }
            if (zhiShiP === 5) zhiShiP = jiPalace;

            const doorStartIdx = DOOR_RING.indexOf(originDoorName);
            const doorTargetIdx = PALACE_TO_RING[zhiShiP];
            let doorOffset = doorTargetIdx - doorStartIdx;
            if (doorOffset < 0) doorOffset += 8;

            let renPan = {};
            for (let i = 0; i < 8; i++) {
                const door = DOOR_RING[i];
                const newRingIdx = (i + doorOffset) % 8;
                const RING_TO_PALACE = [1, 8, 3, 4, 9, 2, 7, 6];
                const p = RING_TO_PALACE[newRingIdx];
                renPan[p] = door;
            }

            const deityTargetIdx = PALACE_TO_RING[hourPalace];
            let shenPan = {};
            for (let i = 0; i < 8; i++) {
                let ringIdx;
                if (isYang) {
                    ringIdx = (deityTargetIdx + i) % 8;
                } else {
                    ringIdx = (deityTargetIdx - i);
                    if (ringIdx < 0) ringIdx += 8;
                }
                const RING_TO_PALACE = [1, 8, 3, 4, 9, 2, 7, 6];
                const p = RING_TO_PALACE[ringIdx];
                shenPan[p] = EIGHT_GODS[i];
            }

            return {
                diPan, tianPan, tianPanStems, renPan, shenPan,
                meta: {
                    isYang, ju,
                    xunShou: xunShouStr,
                    pillars: [JIA_ZI[yearIdx], JIA_ZI[monthIdx], JIA_ZI[dayIdx], JIA_ZI[hourIdx]],
                    dayIdx: dayIdx,
                    hourIdx: hourIdx,
                    zhiFuPalace: hourPalace,
                    zhiShiPalace: zhiShiP,
                    termName: SOLAR_TERMS_NAME[termIdx],
                    termIdx: termIdx
                }
            };
        }

        function getSolarTermInfo(currentTermIdx, date) {
            const nextIdx = (currentTermIdx + 1) % 24;

            let year = date.getFullYear();

            // Find next term date
            let nextDate = getTermTransitionDate(year, nextIdx);
            // If nextDate is earlier than now (e.g. we are in Dec, next is Jan of this year), add 1 year
            if (nextDate.getTime() < date.getTime()) {
                nextDate = getTermTransitionDate(year + 1, nextIdx);
            }

            // Find current term date (start of current term)
            let currDate = getTermTransitionDate(year, currentTermIdx);
            // If currDate is later than now (e.g. we are in Jan, current term is from Dec last year), subtract 1 year
            if (currDate.getTime() > date.getTime()) {
                currDate = getTermTransitionDate(year - 1, currentTermIdx);
            }

            const diffTimeNext = nextDate.getTime() - date.getTime();
            const daysToNext = Math.ceil(diffTimeNext / (1000 * 60 * 60 * 24));

            const diffTimeCurr = date.getTime() - currDate.getTime();
            const daysPassed = Math.floor(diffTimeCurr / (1000 * 60 * 60 * 24));

            return {
                daysToNext: daysToNext > 0 ? daysToNext : 0,
                daysPassed: daysPassed >= 0 ? daysPassed : 0,
                nextTermName: SOLAR_TERMS_NAME[nextIdx]
            };
        }

        function renderChart(data) {
            const grid = document.getElementById('qimen-grid');
            grid.innerHTML = '';

            const LAYOUT = [4, 9, 2, 3, 5, 7, 8, 1, 6];

            // Logic Maps
            const JI_XING_MAP = {
                'æˆŠ': [3], 'å·±': [2], 'åºš': [8], 'è¾›': [9], 'å£¬': [4], 'ç™¸': [4]
            };
            const RU_MU_MAP = {
                'ä¹™': [2], 'ä¸™': [6], 'æˆŠ': [6], 'ä¸': [6], 'å·±': [6],
                'åºš': [8], 'è¾›': [8], 'å£¬': [4], 'ç™¸': [4]
            };
            const DOOR_ELEMENTS = {
                'ä¼‘é–€': 'æ°´', 'æ­»é–€': 'åœŸ', 'å‚·é–€': 'æœ¨', 'æœé–€': 'æœ¨',
                'é–‹é–€': 'é‡‘', 'é©šé–€': 'é‡‘', 'ç”Ÿé–€': 'åœŸ', 'æ™¯é–€': 'ç«'
            };
            const PALACE_ELEMENTS_MAP = { 1: 'æ°´', 2: 'åœŸ', 3: 'æœ¨', 4: 'æœ¨', 5: 'åœŸ', 6: 'é‡‘', 7: 'é‡‘', 8: 'åœŸ', 9: 'ç«' };
            const STEM_ELEMENTS = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };

            // Helper to check element clash (A overcomes B)
            function isOvercoming(elA, elB) {
                if (elA === 'é‡‘' && elB === 'æœ¨') return true;
                if (elA === 'æœ¨' && elB === 'åœŸ') return true;
                if (elA === 'åœŸ' && elB === 'æ°´') return true;
                if (elA === 'æ°´' && elB === 'ç«') return true;
                if (elA === 'ç«' && elB === 'é‡‘') return true;
                return false;
            }

            function isGenerating(elA, elB) {
                if (elA === 'é‡‘' && elB === 'æ°´') return true;
                if (elA === 'æ°´' && elB === 'æœ¨') return true;
                if (elA === 'æœ¨' && elB === 'ç«') return true;
                if (elA === 'ç«' && elB === 'åœŸ') return true;
                if (elA === 'åœŸ' && elB === 'é‡‘') return true;
                return false;
            }

            LAYOUT.forEach(p => {
                const cell = document.createElement('div');
                cell.className = 'palace';
                if (p === 5) cell.className += ' center';

                if (p === data.meta.zhiFuPalace) {
                    cell.classList.add('highlight-zhifu');
                }

                if (p === 5) {
                    const jiPalace = data.meta.isYang ? 8 : 2;
                    const jiName = PALACE_NAMES[jiPalace];
                    cell.innerHTML = `<div class="p-body" style="color:#666; font-size:0.8rem;">ä¸­äº”å®®<br>å¯„${jiName}</div>`;
                } else {
                    const star = data.tianPan[p] || '';
                    const door = data.renPan[p] || '';
                    const god = data.shenPan[p] || '';
                    const heavenStem = data.tianPanStems[p] || '';
                    const earthStem = data.diPan[p] || '';

                    let doorClass = 'door';
                    if (['ç”Ÿé–€', 'é–‹é–€', 'ä¼‘é–€'].includes(door)) doorClass += ' auspicious';

                    // --- Calculate Markers ---
                    let badges = '';

                    // 1. Ji Xing (Heaven Stem vs Palace)
                    if (JI_XING_MAP[heavenStem] && JI_XING_MAP[heavenStem].includes(p)) {
                        badges += `<span class="marker-badge marker-xing">åˆ‘</span>`;
                    }

                    // 2. Ru Mu (Heaven Stem vs Palace)
                    if (RU_MU_MAP[heavenStem] && RU_MU_MAP[heavenStem].includes(p)) {
                        badges += `<span class="marker-badge marker-mu">å¢“</span>`;
                    }

                    // 3. Men Po (Door Element overcomes Palace Element)
                    const doorEl = DOOR_ELEMENTS[door];
                    const palaceEl = PALACE_ELEMENTS_MAP[p];
                    if (doorEl && palaceEl && isOvercoming(doorEl, palaceEl)) {
                        badges += `<span class="marker-badge marker-po">è¿«</span>`;
                    }

                    // --- Calculate Interaction (Heaven vs Earth) ---
                    let interactionHTML = '';
                    if (heavenStem && earthStem) {
                        const hEl = STEM_ELEMENTS[heavenStem];
                        const eEl = STEM_ELEMENTS[earthStem];
                        let iText = '';
                        let iClass = '';

                        if (hEl === eEl) {
                            iText = 'æ¯”å’Œ:å¹³';
                            iClass = 'interaction-neutral';
                        } else if (isGenerating(hEl, eEl)) {
                            iText = 'å¤©ç”Ÿ:é †'; // Heaven generates Earth
                            iClass = 'interaction-good';
                        } else if (isOvercoming(hEl, eEl)) {
                            iText = 'å¤©å‰‹:ç¤™'; // Heaven overcomes Earth
                            iClass = 'interaction-bad';
                        } else if (isGenerating(eEl, hEl)) {
                            iText = 'åœ°ç”Ÿ:ç´¯'; // Earth generates Heaven
                            iClass = 'interaction-warn';
                        } else if (isOvercoming(eEl, hEl)) {
                            iText = 'åœ°å‰‹:åˆ¶'; // Earth overcomes Heaven
                            iClass = 'interaction-control';
                        }

                        if (iText) {
                            interactionHTML = `<div class="interaction-badge ${iClass}">${iText}</div>`;
                        }
                    }

                    cell.innerHTML = `
                    ${interactionHTML}
                    <div class="gong-element">${PALACE_ELEMENTS_MAP[p]}</div>
                    <div class="god">${god}</div>
                    <div class="p-body">
                        <div class="star">${star}</div>
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <div class="${doorClass}">${door}</div>
                            <div style="display:flex; gap:2px; margin-top:2px;">${badges}</div>
                        </div>
                    </div>
                    <div class="stems">
                        <span class="heaven-stem">${heavenStem}</span>
                        <span class="earth-stem">${earthStem}</span>
                    </div>
                    <div class="gong-name">${PALACE_NAMES[p]}</div>
                `;
                }
                grid.appendChild(cell);
            });

            // ... rest of renderChart ...

            const termInfo = getSolarTermInfo(data.meta.termIdx, currentState.date);
            const termText = `${data.meta.termName} (å·²é ${termInfo.daysPassed} å¤©, ${termInfo.daysToNext} å¤©å¾Œ${termInfo.nextTermName})`;

            document.getElementById('bazi-display').innerText = data.meta.pillars.join(' ');
            document.getElementById('ju-shu-display').innerText = `${data.meta.isYang ? 'é™½' : 'é™°'}é ${data.meta.ju} å±€`;
            document.getElementById('xun-shou-display').innerText = data.meta.xunShou;
            document.getElementById('solar-term-display').innerText = termText;

            updateAnalysis(data);
            updateRiskAssessment(data);
            updateChartSummary(data);
            updateJiaHours(data.meta.dayIdx);
        }

        function updateChartSummary(data) {
            const summaryDiv = document.getElementById('chart-summary');

            // 1. Find Palaces for Key Doors
            let doorPalaces = {};
            for (let p in data.renPan) {
                doorPalaces[data.renPan[p]] = parseInt(p);
            }

            // 2. Helper for Analysis
            function analyzePalace(p) {
                const door = data.renPan[p];
                const star = data.tianPan[p];
                const god = data.shenPan[p];
                const hStem = data.tianPanStems[p];
                const eStem = data.diPan[p];

                // Stem Interaction
                const STEM_ELEMENTS = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };
                const hEl = STEM_ELEMENTS[hStem];
                const eEl = STEM_ELEMENTS[eStem];

                let interaction = '';
                let interactionCode = 'neutral'; // great, good, drain, control, bad

                if (hEl === eEl) {
                    interaction = 'æ¯”å’Œ (å¹³ç©©)';
                    interactionCode = 'good';
                } else if ((hEl === 'é‡‘' && eEl === 'æ°´') || (hEl === 'æ°´' && eEl === 'æœ¨') || (hEl === 'æœ¨' && eEl === 'ç«') || (hEl === 'ç«' && eEl === 'åœŸ') || (hEl === 'åœŸ' && eEl === 'é‡‘')) {
                    interaction = 'å¤©ç”Ÿ (é †åˆ©)';
                    interactionCode = 'great';
                } else if ((hEl === 'é‡‘' && eEl === 'æœ¨') || (hEl === 'æœ¨' && eEl === 'åœŸ') || (hEl === 'åœŸ' && eEl === 'æ°´') || (hEl === 'æ°´' && eEl === 'ç«') || (hEl === 'ç«' && eEl === 'é‡‘')) {
                    interaction = 'å¤©å‰‹ (é˜»ç¤™)';
                    interactionCode = 'bad';
                } else if ((eEl === 'é‡‘' && hEl === 'æ°´') || (eEl === 'æ°´' && hEl === 'æœ¨') || (eEl === 'æœ¨' && hEl === 'ç«') || (eEl === 'ç«' && hEl === 'åœŸ') || (eEl === 'åœŸ' && hEl === 'é‡‘')) {
                    interaction = 'åœ°ç”Ÿ (æ¶ˆè€—)';
                    interactionCode = 'drain';
                } else {
                    interaction = 'åœ°å‰‹ (æŒæ§)';
                    interactionCode = 'control';
                }

                return { door, star, god, interaction, interactionCode, hStem, eStem };
            }

            // 3. Dynamic Advice Generator
            function getDynamicAdvice(door, code) {
                const map = {
                    'é–‹é–€': {
                        'great': 'âœ… å®œï¼šå¤§å±•æ‹³è…³ã€é–‹æ¥­ã€è«‡åˆ¤ (ç’°å¢ƒåŠ©åŠ›å¼·)ã€‚',
                        'good': 'âœ… å®œï¼šæ±‚è·ã€é¢è©¦ã€å•Ÿå‹•è¨ˆç•« (å¹³ç©©é †åˆ©)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šä¸»å‹•å‡ºæ“Šï¼Œä½†éœ€ä»˜å‡ºè¼ƒå¤šå¿ƒåŠ› (å¤šå‹å¤šå¾—)ã€‚',
                        'control': 'âš ï¸ å®œï¼šå¼·å‹¢ä¸»å°ï¼Œå…‹æœå›°é›£ (éœ€è¦ªåŠ›è¦ªç‚º)ã€‚',
                        'bad': 'âŒ å¿Œï¼šå†’éšªæ“´å¼µã€‚âœ… å®œï¼šå…§éƒ¨æ•´é “ã€å®ˆæˆ (ç’°å¢ƒä¸åˆ©)ã€‚'
                    },
                    'ç”Ÿé–€': {
                        'great': 'âœ… å®œï¼šæŠ•è³‡ã€æ±‚è²¡ã€ç°½ç´„ (è²¡æ˜Ÿé«˜ç…§)ã€‚',
                        'good': 'âœ… å®œï¼šç¶“ç‡Ÿã€ç‡Ÿé€ ã€ç†è²¡ (ç©©å¥ç²åˆ©)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šè¾›è‹¦æ±‚è²¡ï¼Œä¸å®œæŠ•æ©Ÿ (ä»˜å‡ºæ‰æœ‰æ”¶ç©«)ã€‚',
                        'control': 'âš ï¸ å®œï¼šç©æ¥µçˆ­å–ï¼Œæ§åˆ¶æˆæœ¬ (éœ€ç²¾æ‰“ç´°ç®—)ã€‚',
                        'bad': 'âŒ å¿Œï¼šå¤§é¡æŠ•è³‡ã€‚âœ… å®œï¼šä¿å®ˆå„²è“„ (å®¹æ˜“ç ´è²¡)ã€‚'
                    },
                    'æ™¯é–€': {
                        'great': 'âœ… å®œï¼šè€ƒè©¦ã€ç™¼è¡¨ã€ç¤¾äº¤ (åè²å¤§å™ª)ã€‚',
                        'good': 'âœ… å®œï¼šæ–‡æ›¸è™•ç†ã€è¦åŠƒ (æ€è·¯æ¸…æ™°)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šåè¦†ç¢ºèªç´°ç¯€ (æºé€šæˆæœ¬è¼ƒé«˜)ã€‚',
                        'control': 'âš ï¸ å®œï¼šæ“šç†åŠ›çˆ­ (éœ€è²»å”‡èˆŒ)ã€‚',
                        'bad': 'âŒ å¿Œï¼šå‡ºé¢¨é ­ã€‚âœ… å®œï¼šä½èª¿é€²ä¿® (æ˜“æœ‰å£èˆŒ)ã€‚'
                    },
                    'ä¼‘é–€': {
                        'great': 'âœ… å®œï¼šä¼‘é¤Šã€èšæœƒã€å«å¨¶ (èº«å¿ƒæ”¾é¬†)ã€‚',
                        'good': 'âœ… å®œï¼šèª¿è§£ã€æœƒè¦‹è²´äºº (æ°£æ°›å’Œè«§)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šå¿™è£¡å·é–’ (ç‘£äº‹çºèº«)ã€‚',
                        'control': 'âš ï¸ å®œï¼šå®‰æ’è¡Œç¨‹ (éœ€ä¸»å‹•å”èª¿)ã€‚',
                        'bad': 'âŒ å¿Œï¼šéåº¦å‹ç´¯ã€‚âœ… å®œï¼šå¼·åˆ¶ä¼‘æ¯ (æ˜“ç”Ÿç—…)ã€‚'
                    },
                    'å‚·é–€': {
                        'great': 'âœ… å®œï¼šæ¯”è³½ã€ç«¶æŠ€ã€è¨å‚µ (è´é¢å¤§)ã€‚',
                        'good': 'âœ… å®œï¼šåˆ‘åµã€æ•æ‰ (è¡Œå‹•åŠ›å¼·)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šè‹¦æˆ° (éœ€ä»˜å‡ºä»£åƒ¹æ‰èƒ½è´)ã€‚',
                        'control': 'âš ï¸ å®œï¼šå¼·åŠ›åŸ·æ³• (éœ€å£“åˆ¶å°æ–¹)ã€‚',
                        'bad': 'âŒ å¿Œï¼šçˆ­é¬¥ã€‚âœ… å®œï¼šå¿è€ (æ˜“å—å‚·/å¤±æ•—)ã€‚'
                    },
                    'æœé–€': {
                        'great': 'âœ… å®œï¼šéš±å¯†ç ”ç©¶ã€æŠ€è¡“é–‹ç™¼ (ä¸å—æ‰“æ“¾)ã€‚',
                        'good': 'âœ… å®œï¼šé¿é›£ã€èº²è— (å®‰å…¨ç„¡è™)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šå°‹æ±‚çªç ´ (è·¯è¢«æ“‹ä½ï¼Œéœ€ç¹é“)ã€‚',
                        'control': 'âš ï¸ å®œï¼šè§£æ±ºå•é¡Œ (éœ€é¢å°ç¾å¯¦)ã€‚',
                        'bad': 'âŒ å¿Œï¼šå°é–‰éé ­ã€‚âš ï¸ ç‹€æ…‹ï¼šæ–‡æ›¸æ‹–å»¶ã€å†·è™•ç† (è™•è™•ç¢°å£)ã€‚'
                    },
                    'é©šé–€': {
                        'great': 'âœ… å®œï¼šå¾‹å¸«ã€è¾¯è«–ã€æ¼”èªª (å£æ‰æ¥µä½³)ã€‚',
                        'good': 'âœ… å®œï¼šè¨­ç–‘ã€æ©æ• (è²å‹¢æµ©å¤§)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šè§£é‡‹æ¾„æ¸… (å ´é¢å°·å°¬ï¼Œè¶Šæè¶Šé»‘)ã€‚',
                        'control': 'âš ï¸ å®œï¼šæ“šç†åŠ›çˆ­ (éœ€å¼·å‹¢å£“åˆ¶)ã€‚',
                        'bad': 'âŒ å¿Œï¼šå£èˆŒæ˜¯éã€‚âš ï¸ ç‹€æ…‹ï¼šå—é©šã€æ„å¤–ã€åš´å²å°å¾… (æ˜“æƒ¹ç¦)ã€‚'
                    },
                    'æ­»é–€': {
                        'great': 'âœ… å®œï¼šå®—æ•™ã€å¿ƒéˆæ²‰æ¾± (æ„Ÿæ‚Ÿæ·±)ã€‚',
                        'good': 'âœ… å®œï¼šçµæ¡ˆã€æ–·æ¨é›¢ (ä¹¾æ·¨ä¿è½)ã€‚',
                        'drain': 'âš ï¸ å®œï¼šè™•ç†å¾Œäº‹ (æ‹–æ³¥å¸¶æ°´)ã€‚',
                        'control': 'âš ï¸ å®œï¼šå¼·åˆ¶çµæŸ (éœ€ä¸‹å®šæ±ºå¿ƒ)ã€‚',
                        'bad': 'âŒ å¿Œï¼šé‘½ç‰›è§’å°–ã€‚âœ… å®œï¼šéœå¿ƒ (é‹å‹¢ä½è¿·)ã€‚'
                    }
                };
                return map[door] ? map[door][code] : '';
            }

            // 4. Generate Content for Categories
            const categories = [
                { title: 'äº‹æ¥­ / å·¥ä½œ', door: 'é–‹é–€', icon: 'ğŸ’¼' },
                { title: 'è²¡é‹ / æŠ•è³‡', door: 'ç”Ÿé–€', icon: 'ğŸ’°' },
                { title: 'æ–‡æ›¸ / ç¤¾äº¤', door: 'æ™¯é–€', icon: 'ğŸ“š' },
                { title: 'ä¼‘æ¯ / å¥åº·', door: 'ä¼‘é–€', icon: 'ğŸ˜´' },
                { title: 'ç«¶çˆ­ / è®Šå‹•', door: 'å‚·é–€', icon: 'âš¡' },
                { title: 'é˜»ç¤™ / éš±é', door: 'æœé–€', icon: 'ğŸš§' },
                { title: 'é©šæ / å£èˆŒ', door: 'é©šé–€', icon: 'ğŸ˜±' },
                { title: 'åœæ»¯ / çµæ¡ˆ', door: 'æ­»é–€', icon: 'ğŸ’€' }
            ];

            let htmlContent = '';

            // 5. Calculate Overall Tone (Global Scoring)
            let totalScore = 60; // Base score
            let badGodCount = 0;
            let goodDoorCount = 0;

            // Iterate all palaces to adjust score
            for (let p in data.renPan) {
                const d = data.renPan[p];
                const g = data.shenPan[p];

                if (['é–‹é–€', 'ç”Ÿé–€', 'ä¼‘é–€', 'æ™¯é–€'].includes(d)) {
                    totalScore += 2;
                    goodDoorCount++;
                } else {
                    totalScore -= 2;
                }

                if (['ç™½è™', 'ç„æ­¦', 'é¨°è›‡'].includes(g)) {
                    totalScore -= 3;
                    badGodCount++;
                }
            }

            // Zhi Fu Palace Weighting (The Core)
            const zhiFuP = data.meta.zhiFuPalace;
            const zhiFuInfo = analyzePalace(zhiFuP);

            if (zhiFuInfo.interactionCode === 'great') totalScore += 15;
            else if (zhiFuInfo.interactionCode === 'good') totalScore += 5;
            else if (zhiFuInfo.interactionCode === 'drain') totalScore -= 5;
            else if (zhiFuInfo.interactionCode === 'control') totalScore += 5;
            else if (zhiFuInfo.interactionCode === 'bad') totalScore -= 15;

            let overallTone = 'å¹³ç©©';
            let toneColor = '#ccc';

            if (totalScore >= 85) { overallTone = 'å¤§å‰ (è«¸äº‹é †é‚)'; toneColor = '#f1c40f'; }
            else if (totalScore >= 70) { overallTone = 'å‰ (ç©©å¥ç™¼å±•)'; toneColor = '#2ecc71'; }
            else if (totalScore >= 55) { overallTone = 'å¹³ç©© (æ™®é€š)'; toneColor = '#ccc'; }
            else if (totalScore >= 40) { overallTone = 'æ™®é€šåå‡¶ (è¡¨é¢ç©©ã€æš—æ½®å¤š)'; toneColor = '#e67e22'; }
            else { overallTone = 'å‡¶ (è«¸äº‹ä¸å®œ)'; toneColor = '#e74c3c'; }

            htmlContent += `
                <div style="font-size:1.1rem; font-weight:bold; color:${toneColor}; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                    â­ ç¶œåˆè©•åƒ¹ï¼š${overallTone}
                </div>
                <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
            `;

            categories.forEach(cat => {
                const p = doorPalaces[cat.door];
                if (p) {
                    const info = analyzePalace(p);

                    // Dynamic Advice
                    const yiJi = getDynamicAdvice(cat.door, info.interactionCode);

                    // Special warnings
                    let warnings = '';
                    if (info.god === 'ç„æ­¦') warnings += ' <span style="color:#e74c3c">(é˜²è©é¨™)</span>';
                    if (info.god === 'ç™½è™') warnings += ' <span style="color:#e74c3c">(é˜²çˆ­åŸ·)</span>';
                    if (info.star === 'å¤©èŠ®') warnings += ' <span style="color:#e74c3c">(é˜²å•é¡Œ)</span>';

                    // Interaction Impact Text
                    let interactionImpact = '';
                    if (info.interactionCode === 'great') interactionImpact = 'ğŸš€ <strong>æ ¼å±€ï¼š</strong>å¤©ç”ŸåŠ©åŠ›å¼·ï¼Œé †é¢¨é †æ°´ã€‚';
                    else if (info.interactionCode === 'good') interactionImpact = 'âœ¨ <strong>æ ¼å±€ï¼š</strong>å…§å¤–åŒå¿ƒï¼Œå¹³ç©©ã€‚';
                    else if (info.interactionCode === 'drain') interactionImpact = 'ğŸ’¦ <strong>æ ¼å±€ï¼š</strong>éœ€å¤šä»˜å‡ºå¿ƒåŠ› (åœ°ç”Ÿå¤©)ã€‚';
                    else if (info.interactionCode === 'control') interactionImpact = 'ğŸ”§ <strong>æ ¼å±€ï¼š</strong>ä½ èƒ½æŒæ¡ä¸»å°æ¬Š (åœ°å‰‹å¤©)ã€‚';
                    else if (info.interactionCode === 'bad') interactionImpact = 'â›” <strong>æ ¼å±€ï¼š</strong>å—é˜»ç¤™ï¼Œç’°å¢ƒä¸åˆ© (å¤©å‰‹åœ°)ã€‚';

                    htmlContent += `
                        <div style="background:rgba(255,255,255,0.03); padding:8px; border-radius:5px;">
                            <div style="color:var(--accent-gold); font-weight:bold; font-size:0.95rem; margin-bottom:4px;">
                                ${cat.icon} ${cat.title} (${cat.door})
                            </div>
                            <div style="font-size:0.85rem; color:#ddd; line-height:1.6;">
                                â¡ <strong>${cat.door}</strong> è½ <strong>${PALACE_NAMES[p]}</strong> (è‡¨ ${info.star}ã€${info.god}${warnings})<br>
                                <div style="margin: 4px 0; color:#bbb;">${interactionImpact}</div>
                                <div style="margin-top:4px; padding-top:4px; border-top:1px solid rgba(255,255,255,0.1);">
                                    ${yiJi}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            htmlContent += `</div>`;
            summaryDiv.innerHTML = htmlContent;
        }

        function updateRiskAssessment(data) {
            const riskDiv = document.getElementById('risk-assessment');
            let risks = [];
            let score = 0;

            const zhiFuP = data.meta.zhiFuPalace;
            const hourIdx = data.meta.hourIdx;
            const dayIdx = data.meta.dayIdx;

            // 1. å€¼ç¬¦è½ç©ºäº¡
            const xunIdx = hourIdx - (hourIdx % 10);
            let emptyBranches = [];
            if (xunIdx === 0) emptyBranches = [10, 11];
            else if (xunIdx === 10) emptyBranches = [8, 9];
            else if (xunIdx === 20) emptyBranches = [6, 7];
            else if (xunIdx === 30) emptyBranches = [4, 5];
            else if (xunIdx === 40) emptyBranches = [2, 3];
            else if (xunIdx === 50) emptyBranches = [0, 1];

            const zhiFuBranches = PALACE_BRANCHES[zhiFuP] || [];
            const isKongWang = zhiFuBranches.some(b => emptyBranches.includes(b));

            if (isKongWang) {
                risks.push(`âŒ <strong>å€¼ç¬¦è½ç©ºäº¡</strong> (å¤§å‡¶)ï¼šç™¾äº‹ä¸å¯¦ï¼Œæ‡‰å‰ä¸å‰ï¼Œæ‡‰å‡¶æ›´å‡¶ã€‚`);
                score += 40;
            }

            // 2. å€¼ç¬¦è½æ­»é–€
            if (data.renPan[zhiFuP] === 'æ­»é–€') {
                risks.push(`âŒ <strong>å€¼ç¬¦è½æ­»é–€</strong> (å¤§å‡¶)ï¼šä¸»æ°£æ•¸å°‡ç›¡ï¼Œä¸å®œå¼·è¡Œæ¨å‹•é‡å¤§è¨ˆç•«ã€‚`);
                score += 30;
            }

            // 3. ä¸‰å¥‡å—åˆ¶
            let yiControlled = false;
            let bingControlled = false;
            let dingControlled = false;

            for (let p in data.tianPanStems) {
                const stem = data.tianPanStems[p];
                const palaceEl = PALACE_ELEMENTS[p];

                if (stem === 'ä¹™') {
                    if (palaceEl === 'é‡‘' && !yiControlled) {
                        risks.push(`âŒ <strong>ä¹™å¥‡å—åˆ¶</strong>ï¼šè²´äººé›£ç™¼åŠ›ï¼ŒæœŸæœ›è½ç©ºæˆ–å»¶é²ã€‚`);
                        score += 15;
                        yiControlled = true;
                    }
                }
                if (stem === 'ä¸™') {
                    if (palaceEl === 'æ°´' && !bingControlled) {
                        risks.push(`âŒ <strong>ä¸™å¥‡å—åˆ¶</strong>ï¼šæ–‡æ›¸ã€è€ƒè©¦ã€åè²æ–¹é¢å¤šé˜»æ»¯ã€‚`);
                        score += 15;
                        bingControlled = true;
                    }
                }
                if (stem === 'ä¸') {
                    if (palaceEl === 'æ°´' && !dingControlled) {
                        risks.push(`âŒ <strong>ä¸å¥‡å—åˆ¶</strong>ï¼šäººéš›ã€æ„Ÿæƒ…æˆ–åˆç´„æ˜“æœ‰èª¤æœƒèˆ‡å£èˆŒã€‚`);
                        score += 15;
                        dingControlled = true;
                    }
                }
            }

            // 4. æ—¥å¹²ã€æ™‚å¹²äº’å®³
            const dayGan = TIAN_GAN[dayIdx % 10];
            const hourGan = TIAN_GAN[hourIdx % 10];

            if ((dayGan === 'ç”²' && hourGan === 'åºš') || (dayGan === 'åºš' && hourGan === 'ç”²')) {
                risks.push(`âŒ <strong>æ—¥å¹²ã€æ™‚å¹²äº’å®³ (ç”²åºšæ²–)</strong>ï¼šä¸»å®¢ç«‹å ´å°–éŠ³å°ç«‹ï¼Œå®œé¿é–‹æ­£é¢è¡çªã€‚`);
                score += 20;
            }
            if ((dayGan === 'ä¹™' && hourGan === 'è¾›') || (dayGan === 'è¾›' && hourGan === 'ä¹™')) {
                risks.push(`âŒ <strong>æ—¥å¹²ã€æ™‚å¹²äº’å®³ (ä¹™è¾›æ²–)</strong>ï¼šå½¼æ­¤æš—ä¸­ç‰½åˆ¶ï¼Œäº’æœ‰æå‚·ã€‚`);
                score += 15;
            }
            if ((dayGan === 'ä¸™' && hourGan === 'å£¬') || (dayGan === 'å£¬' && hourGan === 'ä¸™')) {
                risks.push(`âŒ <strong>æ—¥å¹²ã€æ™‚å¹²äº’å®³ (ä¸™å£¬æ²–)</strong>ï¼šæ°´ç«ä¸å®¹ï¼Œæƒ…ç·’èˆ‡ç†æ™ºæ‹‰æ‰¯ã€‚`);
                score += 15;
            }
            if ((dayGan === 'ä¸' && hourGan === 'ç™¸') || (dayGan === 'ç™¸' && hourGan === 'ä¸')) {
                risks.push(`âŒ <strong>æ—¥å¹²ã€æ™‚å¹²äº’å®³ (ä¸ç™¸æ²–)</strong>ï¼šæœ±é›€æŠ•æ±Ÿï¼Œå£èˆŒæ˜¯éèˆ‡æƒ…ç·’ä½è½ä¸¦å­˜ã€‚`);
                score += 15;
            }

            if (score > 100) score = 100;
            lastRiskScore = score;

            let html = '';

            if (score === 0) {
                const label = 'ä½é¢¨éšª Â· 0%';
                const advice = 'ç„¡æ˜é¡¯å¤§å‡¶ä¹‹è±¡ï¼Œå¯ä¾ä¸‰å‰é–€æ–¹ä½è¦åŠƒè¡Œå‹•ã€‚';

                html += `
            <div class="risk-header-row">
                <div style="font-weight:600;">é¢¨éšªæŒ‡æ•¸</div>
                <div class="risk-tag risk-tag-low">${label}</div>
            </div>
            <div class="risk-bar-wrapper">
                <div class="risk-bar-fill risk-bar-low" style="width:5%;"></div>
            </div>
            <div style="margin-top:6px; font-size:0.85rem; color:#ccc;">${advice}</div>
        `;
            } else {
                let level = '';
                let badgeClass = '';
                let barClass = '';
                let advice = '';

                if (score <= 20) {
                    level = 'ä½é¢¨éšª';
                    badgeClass = 'risk-tag-low';
                    barClass = 'risk-bar-low';
                    advice = 'å¤šåŠå®‰å…¨ï¼Œå¯ç…§å¸¸è¡Œå‹•ï¼Œåƒ…éœ€ç•™æ„ç´°ç¯€ã€‚';
                } else if (score <= 50) {
                    level = 'ä¸­åº¦é¢¨éšª';
                    badgeClass = 'risk-tag-medium';
                    barClass = 'risk-bar-medium';
                    advice = 'å®œè¬¹æ…è¡Œäº‹ï¼Œé¿å…æŠ¼æ³¨åœ¨å–®ä¸€æ–¹æ¡ˆæˆ–æ–¹å‘ã€‚';
                } else if (score <= 75) {
                    level = 'åé«˜é¢¨éšª';
                    badgeClass = 'risk-tag-high';
                    barClass = 'risk-bar-high';
                    advice = 'æš«ä»¥è§€æœ›èˆ‡èª¿æ•´ç‚ºä¸»ï¼Œé‡å¤§æ±ºç­–å®œå»¶å¾Œã€‚';
                } else {
                    level = 'é«˜é¢¨éšª';
                    badgeClass = 'risk-tag-very-high';
                    barClass = 'risk-bar-very-high';
                    advice = 'å»ºè­°æš«åœé‡å¤§è¡Œå‹•ï¼Œä»¥éœåˆ¶å‹•ï¼Œé¿é–‹è¡çªèˆ‡ç¡¬ç¢°ç¡¬ã€‚';
                }

                html += `
            <div class="risk-header-row">
                <div style="font-weight:600;">é¢¨éšªæŒ‡æ•¸</div>
                <div class="risk-tag ${badgeClass}">${level} Â· ${score}%</div>
            </div>
            <div class="risk-bar-wrapper">
                <div class="risk-bar-fill ${barClass}" style="width:${score}%;"></div>
            </div>
            <div style="margin-top:6px; font-size:0.85rem; color:#ccc;">${advice}</div>
        `;

                if (risks.length) {
                    html += `<div style="margin-top:10px;">${risks.map(r => `<div style="margin-bottom:5px;">${r}</div>`).join('')}</div>`;
                }
            }

            riskDiv.innerHTML = html;
        }

        function updateJiaHours(dayIdx) {
            const dayGan = dayIdx % 10;
            const startHourStem = (dayGan * 2) % 10;

            let jiaHours = [];
            for (let b = 0; b < 12; b++) {
                let s = (startHourStem + b) % 10;
                if (TIAN_GAN[s] === 'ç”²') {
                    let branchName = DI_ZHI[b];
                    let startH = (b * 2 + 23) % 24;
                    let endH = (startH + 1) % 24;
                    let range = `${startH.toString().padStart(2, '0')}:00-${endH.toString().padStart(2, '0')}:59`;
                    jiaHours.push(`ç”²${branchName} (${range})`);
                }
            }
            document.getElementById('jia-hours-display').innerText = jiaHours.length ? jiaHours.join(', ') : 'ä»Šæ—¥ç„¡ç”²æ™‚';
        }

        function updateAnalysis(data) {
            const luckyDiv = document.getElementById('lucky-directions');
            const patternDiv = document.getElementById('pattern-analysis');

            let luckyHTML = '';
            let patterns = [];

            ['ç”Ÿé–€', 'é–‹é–€', 'ä¼‘é–€'].forEach(door => {
                for (let p in data.renPan) {
                    if (data.renPan[p] === door) {
                        const dir = DIRECTION_NAMES[p];
                        luckyHTML += `<div style="margin-bottom:5px;"><span class="auspicious">${door}</span> åœ¨ <span class="highlight">${dir}æ–¹</span> (${PALACE_NAMES[p]})</div>`;
                    }
                }
            });

            luckyDiv.innerHTML = luckyHTML || 'ç„¡æ˜é¡¯å‰é–€';

            for (let p = 1; p <= 9; p++) {
                if (p === 5) continue;
                const hStem = data.tianPanStems[p];
                const eStem = data.diPan[p];

                if (hStem === 'æˆŠ' && eStem === 'ä¸™') {
                    patterns.push(`<span class="auspicious">é’é¾è¿”é¦–</span> åœ¨ ${DIRECTION_NAMES[p]}æ–¹ (å¤§å‰)`);
                }
                if (hStem === 'ä¸™' && eStem === 'æˆŠ') {
                    patterns.push(`<span class="auspicious">é£›é³¥è·Œç©´</span> åœ¨ ${DIRECTION_NAMES[p]}æ–¹ (å¤§å‰)`);
                }
            }

            patternDiv.innerHTML = patterns.length ? patterns.join('<br>') : 'æš«ç„¡ç‰¹æ®Šå‰æ ¼';
        }

        let isCompassActive = false;
        let lastHeading = 0;

        function toggleCompass() {
            if (!isCompassActive) {
                requestDeviceOrientation();
            } else {
                isCompassActive = false;
                window.removeEventListener('deviceorientation', handleOrientation);
                document.getElementById('rotating-ring').style.transform = `rotate(0deg)`;
                document.getElementById('qimen-grid').classList.remove('compass-active');
                document.querySelectorAll('.palace').forEach(el => {
                    el.style.transform = `rotate(0deg)`;
                });
                document.getElementById('compass-toggle').innerText = "å•Ÿç”¨ç¾…ç›¤";
                document.getElementById('compass-toggle').classList.remove('active');
                document.getElementById('compass-indicator').style.display = 'none';
            }
        }

        function requestDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateCompass();
                        } else {
                            alert("éœ€è¦ç¾…ç›¤æ¬Šé™æ‰èƒ½é¡¯ç¤ºæ–¹ä½");
                        }
                    })
                    .catch(console.error);
            } else {
                activateCompass();
            }
        }

        function activateCompass() {
            isCompassActive = true;
            window.addEventListener('deviceorientation', handleOrientation);
            document.getElementById('qimen-grid').classList.add('compass-active');
            document.getElementById('compass-toggle').innerText = "é—œé–‰ç¾…ç›¤";
            document.getElementById('compass-toggle').classList.add('active');
            document.getElementById('compass-indicator').style.display = 'block';
        }

        function handleOrientation(event) {
            if (!isCompassActive) return;

            const alpha = event.alpha;
            let heading = alpha;
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            }

            lastHeading = heading;
            applyCompassRotation(heading);
        }

        function applyCompassRotation(heading) {
            const ring = document.getElementById('rotating-ring');
            if (ring) {
                ring.style.transform = `rotate(${-heading}deg)`;
            }
        }

        let lastChartSignature = '';

        function update() {
            if (!manualMode) {
                currentState.date = new Date();
            }
            updateDatePicker(currentState.date);

            currentState.solarTime = getTrueSolarTime(currentState.date, userLongitude);

            document.getElementById('solar-time-display').innerText =
                currentState.solarTime.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });

            const chartData = calculateChart(currentState.date, currentState.solarTime);

            const signature = chartData.meta.pillars.join('-') + '-' + chartData.meta.ju + '-' + chartData.meta.isYang;

            if (signature !== lastChartSignature) {
                renderChart(chartData);
                lastChartSignature = signature;

                if (isCompassActive) {
                    applyCompassRotation(lastHeading);
                }
            }
        }

        function updateDatePicker(date, force = false) {
            const pad = (n) => n.toString().padStart(2, '0');
            const str = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
            const picker = document.getElementById('datetime-picker');
            if (force || document.activeElement !== picker) {
                picker.value = str;
            }
        }

        document.getElementById('datetime-picker').addEventListener('change', (e) => {
            if (e.target.value) {
                // Valid input
                manualMode = true;
                currentState.date = new Date(e.target.value);
                update();
                // Force normalize display (e.g. 2025-11-31 -> 2025-12-01 if browser supported it, 
                // or just standard formatting)
                updateDatePicker(currentState.date, true);
            } else {
                // Invalid input (e.g. 2025-11-31 in some browsers results in empty value)
                // Revert to last valid date to fix display
                updateDatePicker(currentState.date, true);
            }
        });

        document.getElementById('datetime-picker').addEventListener('blur', (e) => {
            // Also normalize on blur to be safe
            if (manualMode && currentState.date) {
                updateDatePicker(currentState.date, true);
            }
        });

        let manualMode = false;

        function getTrueSolarTime(date, longitude) {
            if (longitude === null) return date;
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const b = (2 * Math.PI / 364.0) * (dayOfYear - 81);
            const eot = 9.87 * Math.sin(2 * b) - 7.53 * Math.cos(b) - 1.5 * Math.sin(b);
            const timezoneOffsetMinutes = date.getTimezoneOffset();
            const standardMeridian = -1 * (timezoneOffsetMinutes / 60) * 15;
            const longDiff = longitude - standardMeridian;
            const totalCorrectionMinutes = eot + longDiff * 4;
            return new Date(date.getTime() + totalCorrectionMinutes * 60000);
        }

        function getGanZhiYear(date) {
            let year;
            if (date instanceof Date) {
                year = date.getFullYear();
                const m = date.getMonth();
                const d = date.getDate();
                if (m < 1 || (m === 1 && d < 4)) {
                    year -= 1;
                }
            } else {
                year = date;
            }
            return (year - 1984 + 6000) % 60;
        }

        function getGanZhiMonth(date, yearGanIdx) {
            const m = date.getMonth(); const d = date.getDate();
            let b = 0;
            if ((m === 11 && d >= 7) || (m === 0 && d < 6)) b = 0;
            else if ((m === 0 && d >= 6) || (m === 1 && d < 4)) b = 1;
            else if ((m === 1 && d >= 4) || (m === 2 && d < 6)) b = 2;
            else if ((m === 2 && d >= 6) || (m === 3 && d < 5)) b = 3;
            else if ((m === 3 && d >= 5) || (m === 4 && d < 6)) b = 4;
            else if ((m === 4 && d >= 6) || (m === 5 && d < 6)) b = 5;
            else if ((m === 5 && d >= 6) || (m === 6 && d < 7)) b = 6;
            else if ((m === 6 && d >= 7) || (m === 7 && d < 8)) b = 7;
            else if ((m === 7 && d >= 8) || (m === 8 && d < 8)) b = 8;
            else if ((m === 8 && d >= 8) || (m === 9 && d < 8)) b = 9;
            else if ((m === 9 && d >= 8) || (m === 10 && d < 7)) b = 10;
            else b = 11;

            const yearGan = yearGanIdx % 10;
            const startMonthStem = (yearGan * 2 + 2) % 10;
            let dist = (b - 2 + 12) % 12;
            const monthStem = (startMonthStem + dist) % 10;
            return JIA_ZI.indexOf(TIAN_GAN[monthStem] + DI_ZHI[b]);
        }

        function getGanZhiDay(date) {
            // Use UTC to avoid local timezone/DST issues
            const d1 = Date.UTC(2024, 0, 1); // Jia Zi Ref (2024-01-01)
            const d2 = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());

            let extra = 0;
            if (date.getHours() >= 23) {
                extra = 1;
            }

            const diff = Math.round((d2 - d1) / 86400000) + extra;
            return (diff % 60 + 60) % 60;
        }

        function getGanZhiHour(date, dayIdx) {
            let h = date.getHours();
            let b = Math.floor((h + 1) / 2) % 12;
            const dayGan = dayIdx % 10;
            const startHourStem = (dayGan * 2) % 10;
            const s = (startHourStem + b) % 10;
            return JIA_ZI.indexOf(TIAN_GAN[s] + DI_ZHI[b]);
        }

        function getXunShou(idx) { return JIA_ZI[idx - (idx % 10)]; }

        function resetToNow() {
            manualMode = false;
            document.getElementById('datetime-picker').value = '';
            update();
        }



        let userLongitude = null;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                userLongitude = p.coords.longitude;
                update();
            });
        }

        setInterval(() => {
            if (!manualMode) update();
        }, 1000);
        update();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        // Welcome Modal Logic
        function checkWelcomeModal() {
            const hasSeenWelcome = localStorage.getItem('qmdj_welcome_seen');
            if (!hasSeenWelcome) {
                const modal = document.getElementById('welcome-modal');
                // Small delay to ensure transition works
                setTimeout(() => {
                    modal.classList.add('active');
                }, 100);
            }
        }

        function closeWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.remove('active');
            localStorage.setItem('qmdj_welcome_seen', 'true');
        }

        // Run check on load
        window.addEventListener('DOMContentLoaded', checkWelcomeModal);
    </script>
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">æ­¡è¿ä½¿ç”¨ å¥‡é–€éç”² Â· æ™‚ç©ºç¾…ç›¤</div>
            <ul class="disclaimer-list">
                <li>æ­¤å°ˆæ¡ˆç›®å‰ä»è™•æ–¼é è¦½éšæ®µï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å°šæœªå®Œå–„ã€‚</li>
                <li>æ­¤å°ˆæ¡ˆé›–ç„¶èˆ‡å¸‚é¢è»Ÿé«”æ¯”å°æœªç™¼ç¾è¨ˆç®—éŒ¯èª¤ï¼ŒæƒŸä½œè€…äº¦ç‚ºåˆå­¸è€…ï¼Œæ•…ä»ç„¡æ³•ä¿è­‰å®Œå…¨æº–ç¢ºã€‚</li>
                <li>ä½¿ç”¨è€…æ‡‰å°è‡ªå·±çš„æ±ºç­–è² è²¬ï¼Œæœ¬å°ˆæ¡ˆåƒ…æä¾›åƒè€ƒï¼Œè«‹å‹¿å°‡æœ¬å°ˆæ¡ˆä½œç‚ºäº‹æƒ…çš„å”¯ä¸€æ±ºç­–ä¾æ“šï¼Œä½œè€…ä¸ç‚ºæ­¤å°ˆæ¡ˆé€ æˆçš„ä»»ä½•æƒ…æ³è² è²¬ã€‚</li>
            </ul>
            <button class="modal-btn" onclick="closeWelcomeModal()">é–‹å§‹ä½¿ç”¨</button>
        </div>
    </div>
</body>

</html>